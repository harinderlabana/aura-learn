<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura Learn - Accessible Learning Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth.js/1.4.18/mammoth.browser.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        transition: background-color 0.5s, color 0.5s;
        overflow: hidden;
      }
      .font-lexend {
        font-family: "Lexend", sans-serif;
      }

      /* --- Animations --- */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.8s ease-out forwards;
      }
      .animate-fadeInUp {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      /* --- Themes --- */
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --accent-primary: #4f46e5;
        --accent-secondary: #3b82f6;
        --border-color: #e5e7eb;
        --shadow-color: rgba(0, 0, 0, 0.1);
      }
      .dark {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --text-primary: #f0f6fc;
        --text-secondary: #8b949e;
        --accent-primary: #818cf8;
        --accent-secondary: #60a5fa;
        --border-color: #30363d;
        --shadow-color: rgba(0, 0, 0, 0.4);
      }
      .high-contrast {
        --bg-primary: #000000;
        --bg-secondary: #1e1e1e;
        --text-primary: #ffffff;
        --text-secondary: #e0e0e0;
        --accent-primary: #ffff00;
        --accent-secondary: #00ffff;
        --border-color: #ffffff;
        --shadow-color: rgba(255, 255, 255, 0.4);
      }
      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      /* --- Welcome Wizard: Orb & Aurora --- */
      #welcome-wizard {
        background-color: #0d1117;
        background-image: radial-gradient(
          ellipse 80% 80% at 50% -20%,
          rgba(120, 119, 198, 0.3),
          transparent
        );
        transition: background-image 1s ease;
      }
      #wizard-orb,
      #wizard-finish-btn {
        width: 150px;
        height: 150px;
        background: radial-gradient(
          circle,
          rgba(130, 140, 248, 0.4) 0%,
          rgba(130, 140, 248, 0) 70%
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }
      #wizard-orb:hover,
      #wizard-orb:focus-visible,
      #wizard-finish-btn:hover,
      #wizard-finish-btn:focus-visible {
        transform: scale(1.1);
        box-shadow: 0 0 30px rgba(130, 140, 248, 0.5);
      }
      .wizard-option {
        transition: all 0.3s;
        opacity: 0;
        transform: translateY(20px);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
      }
      .wizard-option.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .wizard-option:focus-visible {
        box-shadow: 0 0 0 3px var(--accent-primary);
      }
      .wizard-option.selected {
        background: var(--accent-primary);
        color: var(--bg-primary) !important;
        box-shadow: 0 0 15px var(--accent-primary);
      }
      kbd {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.9em;
      }

      /* --- Main Dashboard --- */
      #main-dashboard kbd {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.9em;
        color: var(--text-secondary);
      }
      .chat-message {
        max-width: 80%;
        padding: 0.75rem 1.25rem;
        border-radius: 1.5rem;
        line-height: 1.6;
        box-shadow: 0 4px 10px var(--shadow-color);
      }
      .chat-message.user {
        background: linear-gradient(
          to right,
          var(--accent-secondary),
          var(--accent-primary)
        );
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.5rem;
      }
      .chat-message.ai {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        margin-right: auto;
        border-bottom-left-radius: 0.5rem;
        border: 1px solid var(--border-color);
      }
      .chat-card {
        background-color: var(--bg-primary);
        padding: 1rem;
        border-radius: 1rem;
        border: 1px solid var(--border-color);
        margin-top: 0.5rem;
      }
      .chat-action-btn {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
      }
      .chat-action-btn:hover {
        background-color: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
      }

      /* Thinking Animation */
      .thinking-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--accent-primary);
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .thinking-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .thinking-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Calendar Drawer */
      #chat-container {
        transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      }
      #calendar-drawer {
        transition: min-width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        min-width: 0;
        width: 0;
        overflow: hidden;
      }
      #calendar-drawer.open {
        min-width: 24rem; /* 384px */
        width: 24rem;
      }
      .calendar-grid-cell {
        aspect-ratio: 1 / 1;
      }
      .calendar-grid-cell.today {
        background-color: var(--accent-primary);
        color: white;
        font-weight: bold;
      }

      /* Simplified Mode */
      .simplified-mode {
        letter-spacing: 0.5px;
        line-height: 1.8;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
      }

      /* Drag & Drop Overlay Fix */
      #drop-overlay {
        display: none; /* Hide by default */
      }
      .drag-over #drop-overlay {
        display: flex; /* Show only when dragging over */
      }
    </style>
  </head>
  <body class="antialiased">
    <!-- SVG Filters for Colorblind Modes -->
    <svg width="0" height="0" style="position: absolute">
      <defs>
        <filter id="protanopia">
          <feColorMatrix
            type="matrix"
            values="0.567, 0.433, 0, 0, 0, 0.558, 0.442, 0, 0, 0, 0, 0.242, 0.758, 0, 0, 0, 0, 0, 1, 0"
          />
        </filter>
        <filter id="deuteranopia">
          <feColorMatrix
            type="matrix"
            values="0.625, 0.375, 0, 0, 0, 0.7, 0.3, 0, 0, 0, 0, 0.3, 0.7, 0, 0, 0, 0, 0, 1, 0"
          />
        </filter>
        <filter id="tritanopia">
          <feColorMatrix
            type="matrix"
            values="0.95, 0.05, 0, 0, 0, 0, 0.433, 0.567, 0, 0, 0, 0.475, 0.525, 0, 0, 0, 0, 0, 1, 0"
          />
        </filter>
      </defs>
    </svg>

    <!-- Welcome Wizard -->
    <div
      id="welcome-wizard"
      class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 text-white"
    >
      <div id="wizard-content" class="text-center animate-fadeIn">
        <h1
          id="wizard-title"
          class="text-4xl md:text-5xl font-bold font-lexend tracking-tight"
        >
          Welcome to Aura
        </h1>
        <p id="wizard-subtitle" class="mt-4 text-lg text-gray-300">
          Let's personalize your learning experience.
        </p>
      </div>
      <div class="relative mt-12 flex items-center justify-center h-[150px]">
        <button
          id="wizard-orb"
          class="absolute rounded-full flex items-center justify-center shadow-2xl animate-fadeIn font-semibold"
          style="animation-delay: 0.5s"
        >
          Press Enter
        </button>
        <div
          id="wizard-options-container"
          class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex gap-6 md:gap-10 transition-all duration-500"
        >
          <!-- Options will be injected here by JS -->
        </div>
        <button
          id="wizard-finish-btn"
          class="hidden absolute rounded-full flex items-center justify-center shadow-2xl font-semibold text-center leading-tight"
        >
          Begin<br />Journey
        </button>
      </div>
      <p
        id="wizard-keyboard-hint"
        class="hidden mt-8 text-sm text-gray-400 animate-fadeInUp"
      >
        Use <kbd>Tab</kbd> to move and <kbd>Enter</kbd> to select.
      </p>
    </div>

    <!-- Main Application -->
    <div id="main-dashboard" class="hidden h-screen w-full flex flex-col">
      <!-- Header -->
      <header
        class="flex items-center justify-between p-4 border-b shrink-0 z-10"
        style="
          border-color: var(--border-color);
          background-color: var(--bg-primary);
        "
      >
        <h1
          class="font-lexend font-bold text-2xl"
          style="color: var(--accent-primary)"
        >
          Aura Learn
        </h1>
        <div class="flex items-center gap-2">
          <button
            id="open-calendar-btn"
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            aria-label="Open Calendar"
          >
            <svg
              class="h-6 w-6 text-gray-600 dark:text-gray-300"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </button>
          <button
            id="open-settings-btn"
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            aria-label="Open Settings"
          >
            <svg
              class="h-6 w-6 text-gray-600 dark:text-gray-300"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
          </button>
        </div>
      </header>

      <div class="flex-1 flex overflow-hidden">
        <!-- AI Chat Area -->
        <main
          id="chat-container"
          class="w-full flex-1 relative flex flex-col p-4 md:p-6 min-h-0"
        >
          <div id="chat-window" class="flex-1 overflow-y-auto space-y-6 pb-4">
            <!-- Initial prompt will be injected here -->
          </div>
          <div class="mt-4 shrink-0">
            <div id="file-staging-area" class="flex flex-wrap gap-2 mb-2">
              <!-- Staged file pills will be injected here -->
            </div>
            <p
              id="main-keyboard-hint"
              class="mb-2 text-sm text-center"
              style="color: var(--text-secondary)"
            >
              Shortcuts: <span id="shortcut-hint-content"></span>
            </p>
            <div
              class="p-2 rounded-2xl border-2 flex items-center gap-2"
              style="
                background-color: var(--bg-secondary);
                border-color: var(--border-color);
              "
            >
              <input
                type="file"
                id="file-upload-input"
                class="hidden"
                multiple
              />
              <button
                id="file-upload-btn"
                class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                aria-label="Upload file"
              >
                <svg
                  class="h-6 w-6 text-gray-500 dark:text-gray-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
                  />
                </svg>
              </button>
              <input
                type="text"
                id="chat-input"
                class="flex-1 p-2 bg-transparent focus:outline-none"
                style="color: var(--text-primary)"
                placeholder="Type a message or drop files..."
              />
              <button
                id="send-chat-btn"
                class="px-5 py-2 font-semibold rounded-xl text-white transition-transform transform hover:scale-105"
                style="background-color: var(--accent-primary)"
              >
                Send
              </button>
            </div>
          </div>
          <div
            id="drop-overlay"
            class="absolute inset-0 z-10 bg-indigo-500 bg-opacity-75 items-center justify-center text-white text-2xl font-bold"
          >
            Drop your files here!
          </div>
        </main>

        <!-- Calendar Drawer -->
        <aside
          id="calendar-drawer"
          class="h-full flex flex-col border-l"
          style="
            border-color: var(--border-color);
            background-color: var(--bg-primary);
          "
        >
          <div class="p-6 shrink-0">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold font-lexend">Calendar</h2>
              <button
                id="close-calendar-btn"
                class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
                aria-label="Close Calendar"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div id="calendar-auth" class="mt-8 text-center">
              <div id="signed-out-view">
                <p class="text-sm" style="color: var(--text-secondary)">
                  Sign in to view and add events to your Google Calendar.
                </p>
                <button
                  id="google-signin-btn"
                  class="mt-4 px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600"
                >
                  Sign In with Google
                </button>
              </div>
              <div id="signed-in-view" class="hidden">
                <p id="user-email" class="text-sm font-medium"></p>
                <button
                  id="google-signout-btn"
                  class="mt-2 text-xs text-red-500 hover:underline"
                >
                  Sign Out
                </button>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto px-6">
            <div id="calendar-dynamic-view" class="mt-6 hidden">
              <div class="flex items-center justify-between">
                <button
                  id="prev-month-btn"
                  class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"
                >
                  &lt;
                </button>
                <h3 id="calendar-month-year" class="font-semibold text-lg"></h3>
                <button
                  id="next-month-btn"
                  class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"
                >
                  &gt;
                </button>
              </div>
              <div
                id="calendar-grid-header"
                class="grid grid-cols-7 gap-1 text-xs text-center mt-4"
                style="color: var(--text-secondary)"
              >
                <div>S</div>
                <div>M</div>
                <div>T</div>
                <div>W</div>
                <div>T</div>
                <div>F</div>
                <div>S</div>
              </div>
              <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                <!-- Calendar days will be generated here -->
              </div>
            </div>

            <div id="calendar-content" class="mt-6 hidden">
              <h3 class="font-semibold">Upcoming Events</h3>
              <ul id="calendar-events-list" class="mt-2 space-y-2">
                <!-- Events will be populated here -->
              </ul>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- DOM Elements ---
        const welcomeWizard = document.getElementById("welcome-wizard");
        const wizardContent = {
          title: document.getElementById("wizard-title"),
          subtitle: document.getElementById("wizard-subtitle"),
          orb: document.getElementById("wizard-orb"),
          optionsContainer: document.getElementById("wizard-options-container"),
          finishBtn: document.getElementById("wizard-finish-btn"),
          keyboardHint: document.getElementById("wizard-keyboard-hint"),
        };

        const mainDashboard = document.getElementById("main-dashboard");
        const chatContainer = document.getElementById("chat-container");
        const dropOverlay = document.getElementById("drop-overlay");
        const openSettingsBtn = document.getElementById("open-settings-btn");
        const calendarDrawer = document.getElementById("calendar-drawer");
        const openCalendarBtn = document.getElementById("open-calendar-btn");
        const closeCalendarBtn = document.getElementById("close-calendar-btn");
        const chatWindow = document.getElementById("chat-window");
        const chatInput = document.getElementById("chat-input");
        const sendChatBtn = document.getElementById("send-chat-btn");
        const fileUploadInput = document.getElementById("file-upload-input");
        const fileUploadBtn = document.getElementById("file-upload-btn");
        const fileStagingArea = document.getElementById("file-staging-area");
        const shortcutHintContent = document.getElementById(
          "shortcut-hint-content"
        );

        // Calendar Elements
        const googleSignInBtn = document.getElementById("google-signin-btn");
        const googleSignOutBtn = document.getElementById("google-signout-btn");
        const signedInView = document.getElementById("signed-in-view");
        const signedOutView = document.getElementById("signed-out-view");
        const userEmailEl = document.getElementById("user-email");
        const calendarContent = document.getElementById("calendar-content");
        const calendarEventsList = document.getElementById(
          "calendar-events-list"
        );
        const calendarDynamicView = document.getElementById(
          "calendar-dynamic-view"
        );
        const calendarMonthYear = document.getElementById(
          "calendar-month-year"
        );
        const calendarGrid = document.getElementById("calendar-grid");
        const prevMonthBtn = document.getElementById("prev-month-btn");
        const nextMonthBtn = document.getElementById("next-month-btn");

        let preferences = {
          theme: "dark",
          colorblindMode: "none",
          fontSize: "100%",
          aiComplexity: "standard",
        };

        let chatState = "idle";
        let stagedFiles = [];
        let isGoogleSignedIn = false;
        let mockCalendarEvents = [];
        let calendarDate = new Date();
        const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;

        // --- Wizard Logic ---
        const wizardSteps = [
          {
            title: "Let's get the lighting just right.",
            subtitle: "Choose your preferred theme.",
            key: "theme",
            options: [
              { value: "light", label: "☀️", name: "Light" },
              { value: "dark", label: "🌙", name: "Dark" },
              {
                value: "high-contrast",
                label:
                  '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 8 8A8 8 0 0 0 8 0zM7 14a6 6 0 0 1-6-6v0a6 6 0 0 1 6-6v12z"/></svg>',
                name: "Contrast",
              },
            ],
          },
          {
            title: "Adjust for color vision.",
            subtitle: "Select a filter if needed.",
            key: "colorblindMode",
            options: [
              { value: "none", label: "🌈", name: "None" },
              { value: "protanopia", label: "P", name: "Protanopia" },
              { value: "deuteranopia", label: "D", name: "Deuteranopia" },
              { value: "tritanopia", label: "T", name: "Tritanopia" },
            ],
          },
          {
            title: "Set your preferred text size.",
            subtitle: "Make reading comfortable for you.",
            key: "fontSize",
            options: [
              { value: "90%", label: "A-", name: "Small" },
              { value: "100%", label: "Aa", name: "Default" },
              { value: "110%", label: "A+", name: "Large" },
            ],
          },
          {
            title: "How detailed should Aura be?",
            subtitle: "Select your preferred learning style.",
            key: "aiComplexity",
            options: [
              { value: "simplified", label: "🤖", name: "Simplified" },
              { value: "standard", label: "✨", name: "Standard" },
              { value: "complex", label: "🧠", name: "Detailed" },
            ],
          },
        ];
        let currentStep = 0;

        function renderWizardStep() {
          const step = wizardSteps[currentStep];
          wizardContent.title.textContent = step.title;
          wizardContent.subtitle.textContent = step.subtitle;
          wizardContent.optionsContainer.innerHTML = "";

          step.options.forEach((opt) => {
            const button = document.createElement("button");
            const buttonSize =
              step.key === "colorblindMode" || step.key === "fontSize"
                ? "w-24 h-24"
                : "w-28 h-28";
            button.className = `wizard-option ${buttonSize} rounded-full flex flex-col items-center justify-center text-white font-semibold border border-white/10`;

            let nameClass = "text-sm";
            if (step.key === "colorblindMode") {
              nameClass = "text-xs leading-tight";
            }

            button.innerHTML = `<span class="text-4xl">${opt.label}</span><span class="mt-1 ${nameClass}">${opt.name}</span>`;

            const handleSelection = () => {
              preferences[step.key] = opt.value;
              if (step.key === "theme") applyPreferences(true);

              const siblings =
                wizardContent.optionsContainer.querySelectorAll("button");
              siblings.forEach((s) => s.classList.remove("selected"));
              button.classList.add("selected");

              setTimeout(nextWizardStep, 400);
            };

            button.onclick = handleSelection;
            button.onkeydown = (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                handleSelection();
              }
              if (e.key === "Tab") {
                e.preventDefault();
                const options = Array.from(
                  wizardContent.optionsContainer.querySelectorAll(
                    ".wizard-option"
                  )
                );
                const currentIndex = options.findIndex(
                  (opt) => opt === e.target
                );
                let nextIndex = e.shiftKey
                  ? (currentIndex - 1 + options.length) % options.length
                  : (currentIndex + 1) % options.length;
                options[nextIndex].focus();
              }
            };
            wizardContent.optionsContainer.appendChild(button);
          });

          const options =
            wizardContent.optionsContainer.querySelectorAll(".wizard-option");
          if (options.length > 0) {
            setTimeout(() => options[0].focus(), 100);
          }
          options.forEach((opt, index) => {
            setTimeout(() => opt.classList.add("visible"), 100 * index);
          });
        }

        function nextWizardStep() {
          currentStep++;
          if (currentStep < wizardSteps.length) {
            const options =
              wizardContent.optionsContainer.querySelectorAll(".wizard-option");
            options.forEach((opt) => opt.classList.remove("visible"));
            setTimeout(renderWizardStep, 300);
          } else {
            wizardContent.title.textContent = "All set!";
            wizardContent.subtitle.textContent =
              "Your personalized dashboard is ready.";
            wizardContent.optionsContainer.innerHTML = "";
            wizardContent.finishBtn.classList.remove("hidden");
            wizardContent.finishBtn.classList.add("animate-fadeInUp");
            wizardContent.finishBtn.focus();
          }
        }

        // --- Main App Functions ---
        function applyPreferences(isWizard = false) {
          document.documentElement.className = "";
          if (preferences.theme === "dark")
            document.documentElement.classList.add("dark");
          else if (preferences.theme === "high-contrast")
            document.documentElement.classList.add("high-contrast");

          document.documentElement.style.filter =
            preferences.colorblindMode !== "none"
              ? `url(#${preferences.colorblindMode})`
              : "";
          document.documentElement.style.fontSize = preferences.fontSize;

          if (!isWizard) {
            document.body.classList.toggle(
              "simplified-mode",
              preferences.aiComplexity === "simplified"
            );
          }
        }

        function loadPreferences() {
          return false;
        }

        function saveAndApplyPreferences() {
          applyPreferences();
        }

        function addMessageToChat(sender, content, isLoading = false) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `chat-message ${sender} animate-fadeInUp`;
          if (isLoading) {
            messageDiv.innerHTML = `<div class="thinking-indicator"><span></span><span></span><span></span></div>`;
          } else {
            messageDiv.innerHTML = content;
          }
          chatWindow.appendChild(messageDiv);
          chatWindow.scrollTop = chatWindow.scrollHeight;
          return messageDiv;
        }

        // --- Google Calendar Integration (Mocked) ---
        function initializeGapiClientMock() {
          if (googleSignInBtn) {
            googleSignInBtn.disabled = false;
            googleSignInBtn.textContent = "Sign In with Google";
          }
        }

        function updateCalendarView() {
          if (isGoogleSignedIn) {
            signedOutView.classList.add("hidden");
            signedInView.classList.remove("hidden");
            calendarContent.classList.remove("hidden");
            calendarDynamicView.classList.remove("hidden");
            userEmailEl.textContent = "student@example.com"; // Mock email
          } else {
            signedOutView.classList.remove("hidden");
            signedInView.classList.add("hidden");
            calendarContent.classList.add("hidden");
            calendarDynamicView.classList.add("hidden");
          }
        }
        function addEventToGoogleCalendar(eventDetails) {
          if (!isGoogleSignedIn) {
            addMessageToChat(
              "ai",
              `<p>Please sign in to your Google Account first to add calendar events.</p>`
            );
            calendarDrawer.classList.add("open");
            return;
          }

          const newEvent = {
            summary: eventDetails.title,
            start: { date: eventDetails.dueDate },
          };
          mockCalendarEvents.unshift(newEvent);
          renderCalendarEvents();
          renderCalendarGrid();

          const btn = eventDetails.button;
          btn.textContent = "Added!";
          btn.style.backgroundColor = "#10B981"; // Green
          setTimeout(() => {
            btn.textContent = "Add";
            btn.style.backgroundColor = "var(--accent-primary)";
          }, 2000);
        }
        function renderCalendarGrid() {
          calendarGrid.innerHTML = "";
          const month = calendarDate.getMonth();
          const year = calendarDate.getFullYear();
          calendarMonthYear.textContent = `${calendarDate.toLocaleString(
            "default",
            { month: "long" }
          )} ${year}`;

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.appendChild(document.createElement("div"));
          }

          const today = new Date();
          for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            cell.className =
              "calendar-grid-cell flex items-center justify-center rounded-full text-sm";
            cell.textContent = day;
            if (
              day === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear()
            ) {
              cell.classList.add("today");
            }
            calendarGrid.appendChild(cell);
          }
        }
        function renderCalendarEvents() {
          calendarEventsList.innerHTML = "";
          if (mockCalendarEvents.length === 0) {
            calendarEventsList.innerHTML = `<li class="text-sm text-center" style="color: var(--text-secondary)">No upcoming events.</li>`;
            return;
          }
          mockCalendarEvents.sort(
            (a, b) =>
              new Date(a.start.date || a.start.dateTime) -
              new Date(b.start.date || b.start.dateTime)
          );

          mockCalendarEvents.forEach((event) => {
            const li = document.createElement("li");
            li.className = "p-3 rounded-lg flex items-start gap-3";
            li.style.backgroundColor = "var(--bg-secondary)";
            const date = new Date(event.start.date || event.start.dateTime);
            const formattedDate = `<div class="text-center shrink-0"><p class="font-bold text-lg">${date.getDate()}</p><p class="text-xs uppercase" style="color: var(--text-secondary);">${date.toLocaleString(
              "default",
              { month: "short" }
            )}</p></div>`;
            li.innerHTML = `${formattedDate}<div><p class="font-semibold">${event.summary}</p></div>`;
            calendarEventsList.appendChild(li);
          });
        }
        function renderStagedFiles() {
          fileStagingArea.innerHTML = "";
          stagedFiles.forEach((file, index) => {
            const pill = document.createElement("div");
            pill.className =
              "bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2";
            pill.innerHTML = `<span>${file.name}</span><button data-index="${index}" class="remove-file-btn text-indigo-500 hover:text-indigo-700">&times;</button>`;
            fileStagingArea.appendChild(pill);
          });
        }
        async function processSyllabusWithAI(textContent) {
          const loadingMessage = addMessageToChat("ai", "", true);
          await new Promise((resolve) => setTimeout(resolve, 2000));

          let summaryText;
          switch (preferences.aiComplexity) {
            case "simplified":
              summaryText =
                "This is a class about AI. You have 3 homeworks and 2 tests.";
              break;
            case "complex":
              summaryText =
                "This course, Introduction to Artificial Intelligence (CS-401), provides a comprehensive overview of the fundamental principles and techniques of AI. The grading schema is weighted as follows: Assignments (3 total at 15% each, totaling 45%), a Midterm Examination (25%), and a cumulative Final Examination (30%).";
              break;
            default:
              summaryText =
                "This is an Intro to AI class, focusing on core concepts. Your grade is based on 3 assignments, a midterm, and a final exam. Key areas of study will include search algorithms, machine learning, and natural language processing.";
          }
          const mockResponse = {
            summary: summaryText,
            keyDates: [
              { title: "Assignment 1: Search", dueDate: "2025-09-29" },
              { title: "Midterm Exam", dueDate: "2025-10-20" },
              { title: "Final Exam", dueDate: "2025-12-15" },
            ],
          };

          let htmlResponse = `<p>${mockResponse.summary}</p><div class="chat-card"><h4 class="font-semibold mb-2">Key Dates</h4><ul class="space-y-1">`;
          mockResponse.keyDates.forEach((item, index) => {
            htmlResponse += `<li class="flex justify-between items-center text-sm p-2 rounded-lg" style="background-color: var(--bg-primary);"><span>${item.title} - ${item.dueDate}</span><button data-event-index="${index}" class="add-to-calendar-btn text-xs px-2 py-1 rounded" style="background-color: var(--accent-primary); color: var(--bg-primary);">Add</button></li>`;
          });
          htmlResponse += `</ul></div>`;

          loadingMessage.innerHTML = htmlResponse;
          loadingMessage
            .querySelectorAll(".add-to-calendar-btn")
            .forEach((button) => {
              const eventIndex = parseInt(button.dataset.eventIndex);
              const eventData = {
                ...mockResponse.keyDates[eventIndex],
                button: button,
              };
              button.onclick = () => addEventToGoogleCalendar(eventData);
            });
          chatState = "idle";
        }
        async function createStudyGuideWithAI(fileContents) {
          const loadingMessage = addMessageToChat("ai", "", true);
          await new Promise((resolve) => setTimeout(resolve, 4000));

          let concepts, summary, questions;
          switch (preferences.aiComplexity) {
            case "simplified":
              concepts = `<li><strong>AI:</strong> Smart computers.</li><li><strong>Algorithm:</strong> A set of computer rules.</li>`;
              summary = `<li>Your notes talk about AI rules.</li><li>The slides show how AI learns from examples.</li>`;
              questions = `<li>What is AI?</li><li>What is Machine Learning?</li>`;
              break;
            case "complex":
              concepts = `<li><strong>Heuristic Search:</strong> An AI search technique that employs heuristics (problem-specific knowledge) to guide the search, such as A*, which finds the shortest path by estimating the cost to reach the goal. Admissibility and consistency are key properties of such heuristics.</li><li><strong>Supervised Learning:</strong> A machine learning paradigm where a model learns from a dataset containing labeled examples (input-output pairs). The goal is to learn a mapping function that can predict the output variable from new input data. Key challenges include overfitting, which can be mitigated by techniques like cross-validation and regularization.</li>`;
              summary = `<li>The lecture slides introduce foundational search algorithms, contrasting uninformed (BFS, DFS) with informed (Greedy, A*) search techniques, emphasizing the mathematical role of the heuristic function.</li><li>Your personal notes elaborate on the practical applications of supervised learning models, specifically referencing regression for continuous value prediction (e.g., housing prices) and classification for categorical outcomes (e.g., spam detection).</li>`;
              questions = `<li>Compare and contrast the admissibility and consistency of a heuristic in the context of A* search. Provide an example of an admissible but inconsistent heuristic.</li><li>How would you mitigate overfitting in a decision tree classification model based on the provided notes? Explain the mechanism of pruning.</li>`;
              break;
            default: // standard
              concepts = `<li><strong>Artificial Intelligence:</strong> The theory and development of computer systems able to perform tasks that normally require human intelligence, such as visual perception or decision-making.</li><li><strong>Machine Learning:</strong> A subset of AI where systems automatically learn from data to identify patterns and make decisions with minimal human intervention.</li>`;
              summary = `<li>The combined materials cover the basics of AI, including search algorithms from the slides and machine learning concepts from your notes.</li><li>Key topics include the difference between supervised (labeled data) and unsupervised (unlabeled data) learning.</li>`;
              questions = `<li>What are the main components of an AI agent according to the slides?</li><li>Explain the difference between classification and regression with an example for each.</li>`;
          }

          const htmlResponse = `
            <p>Here is your personalized study guide based on the documents provided:</p>
            <div class="chat-card">
                <h4 class="font-semibold mb-2">Key Concepts</h4>
                <ul class="list-disc list-inside space-y-1">${concepts}</ul>
                <h4 class="font-semibold mt-4 mb-2">Topic Summary</h4>
                <ul class="list-disc list-inside space-y-1">${summary}</ul>
                <h4 class="font-semibold mt-4 mb-2">Potential Quiz Questions</h4>
                <ul class="list-disc list-inside space-y-1">${questions}</ul>
            </div>`;

          loadingMessage.innerHTML = htmlResponse;
          chatState = "idle";
        }
        async function transcribeMediaWithAI(file) {
          const loadingMessage = addMessageToChat("ai", "", true);
          await new Promise((resolve) => setTimeout(resolve, 5000));

          let transcript;
          switch (preferences.aiComplexity) {
            case "simplified":
              transcript = `<p><b>[00:00] PROFESSOR:</b> Today we talk about AI.</p><p><b>[00:05] PROFESSOR:</b> AI is about smart computers.</p>`;
              break;
            case "complex":
              transcript = `<p><b>[00:00:01.240 --> 00:00:05.880] PROFESSOR:</b> Good morning, everyone. Today, we're going to delve into the foundational principles of Artificial Intelligence.</p><p><b>[00:06.120 --> 00:00:11.450] PROFESSOR:</b> Specifically, we will be examining the distinctions between weak AI, or Artificial Narrow Intelligence, and the theoretical construct of strong AI, also known as Artificial General Intelligence.</p>`;
              break;
            default: // standard
              transcript = `<p><b>[00:00] PROFESSOR:</b> Okay, class, let's get started. Today's lecture is on the basics of Artificial Intelligence.</p><p><b>[00:05] PROFESSOR:</b> At its core, AI is the simulation of human intelligence in machines.</p>`;
          }

          const htmlResponse = `
            <p>Here is the transcript for <b>${file.name}</b>:</p>
            <div class="chat-card max-h-48 overflow-y-auto">
                ${transcript}
            </div>
            <button class="download-transcript-btn mt-2 text-sm px-3 py-1 rounded" style="background-color: var(--accent-primary); color: var(--bg-primary);">Download Transcript</button>
        `;
          loadingMessage.innerHTML = htmlResponse;

          const downloadBtn = loadingMessage.querySelector(
            ".download-transcript-btn"
          );
          downloadBtn.onclick = () => {
            const transcriptContent = Array.from(
              loadingMessage.querySelectorAll(".chat-card p")
            )
              .map((p) => p.textContent)
              .join("\n");
            const blob = new Blob([transcriptContent], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${file.name.split(".")[0]}_transcript.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };
          chatState = "idle";
        }
        async function getAIChatResponse(userInput) {
          const loadingMessage = addMessageToChat("ai", "", true);
          await new Promise((resolve) => setTimeout(resolve, 1500));
          let response;
          switch (preferences.aiComplexity) {
            case "simplified":
              response = "I'm Aura. I help with school work. Ask me anything!";
              break;
            case "complex":
              response =
                "I am Aura, a sophisticated AI learning assistant developed to provide in-depth, contextual support for your academic endeavors. My capabilities include detailed topic explanation, source analysis, and complex problem-solving. What specific area can I assist you with?";
              break;
            default:
              response =
                "I am Aura, an AI learning assistant here to support your academic journey. How can I help you further?";
          }
          loadingMessage.innerHTML = `<p>${response}</p>`;
        }
        async function processStagedFiles() {
          if (stagedFiles.length === 0) return;
          const fileNames = stagedFiles.map((f) => f.name).join(", ");
          addMessageToChat("user", `<p>Uploaded: ${fileNames}</p>`);
          if (chatState === "awaitingSyllabus") {
            handleTextExtraction(stagedFiles[0], processSyllabusWithAI);
          } else if (chatState === "awaitingStudyGuideFiles") {
            const allTextContents = [];
            let filesProcessed = 0;
            stagedFiles.forEach((file) => {
              handleTextExtraction(file, (textContent) => {
                allTextContents.push(textContent);
                filesProcessed++;
                if (filesProcessed === stagedFiles.length) {
                  createStudyGuideWithAI(allTextContents);
                }
              });
            });
          } else if (chatState === "awaitingMedia") {
            const mediaFile = stagedFiles.find(
              (f) => f.type.startsWith("audio/") || f.type.startsWith("video/")
            );
            if (mediaFile) {
              transcribeMediaWithAI(mediaFile);
            }
          } else {
            const textFile = stagedFiles.find(
              (f) =>
                f.type.startsWith("application/pdf") ||
                f.type.includes("wordprocessingml.document")
            );
            if (textFile) {
              handleTextExtraction(textFile, processSyllabusWithAI);
            }
          }
          stagedFiles = [];
          renderStagedFiles();
        }
        async function onSendChat() {
          const userInput = chatInput.value.trim();
          if (!userInput && stagedFiles.length === 0) return;
          let message = userInput;
          if (stagedFiles.length > 0) {
            message = `[${stagedFiles
              .map((f) => f.name)
              .join(", ")}] ${userInput}`;
          }
          if (message) {
            addMessageToChat("user", `<p>${message}</p>`);
          }
          if (stagedFiles.length > 0) {
            processStagedFiles();
          } else if (userInput) {
            getAIChatResponse(userInput);
          }
          chatInput.value = "";
        }
        async function handleTextExtraction(file, callback) {
          if (!file) return;
          let textContent = "";
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              if (file.type.startsWith("application/pdf")) {
                const typedarray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                  textContent += (
                    await (await pdf.getPage(i)).getTextContent()
                  ).items
                    .map((item) => item.str)
                    .join(" ");
                }
              } else if (file.type.includes("wordprocessingml.document")) {
                textContent = (
                  await mammoth.extractRawText({ arrayBuffer: e.target.result })
                ).value;
              } else {
                addMessageToChat(
                  "ai",
                  `<p>Skipping ${file.name}: not a supported text file.</p>`
                );
                return;
              }
              callback(textContent);
            } catch (error) {
              console.error("File processing error:", error);
              addMessageToChat(
                "ai",
                `<p>Sorry, I had trouble reading ${file.name}.</p>`
              );
            }
          };
          reader.readAsArrayBuffer(file);
        }
        function showInitialPrompt() {
          const promptHTML = `
            <p>Hello! I'm Aura. What would you like to do today?</p>
            <div class="flex flex-wrap gap-2 mt-3">
                <button data-action="analyzeSyllabus" class="chat-action-btn">Analyze Syllabus</button>
                <button data-action="createStudyGuide" class="chat-action-btn">Create Study Guide</button>
                <button data-action="transcribeMedia" class="chat-action-btn">Transcribe Media File</button>
                <button data-action="askQuestion" class="chat-action-btn">Just Ask a Question</button>
            </div>`;
          addMessageToChat("ai", promptHTML);
        }
        function initializeMainApp() {
          openSettingsBtn.style.display = "none";
          const modifierKey = isMac ? "<kbd>Cmd</kbd>" : "<kbd>Alt</kbd>";
          shortcutHintContent.innerHTML = `<kbd>${modifierKey}+K</kbd> Calendar, <kbd>${modifierKey}+C</kbd> Chat`;
          const toggleCalendar = () => calendarDrawer.classList.toggle("open");
          openCalendarBtn.addEventListener("click", toggleCalendar);
          openCalendarBtn.addEventListener("keydown", (e) => {
            if (e.key === "Enter") toggleCalendar();
          });
          closeCalendarBtn.addEventListener("click", toggleCalendar);
          sendChatBtn.addEventListener("click", onSendChat);
          chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") onSendChat();
          });
          fileUploadBtn.addEventListener("click", () =>
            fileUploadInput.click()
          );
          fileUploadInput.addEventListener("change", (e) => {
            Array.from(e.target.files).forEach((file) =>
              stagedFiles.push(file)
            );
            renderStagedFiles();
          });
          chatContainer.addEventListener("dragover", (e) => {
            e.preventDefault();
            chatContainer.classList.add("drag-over");
          });
          chatContainer.addEventListener("dragleave", () =>
            chatContainer.classList.remove("drag-over")
          );
          chatContainer.addEventListener("drop", (e) => {
            e.preventDefault();
            chatContainer.classList.remove("drag-over");
            Array.from(e.dataTransfer.files).forEach((file) =>
              stagedFiles.push(file)
            );
            renderStagedFiles();
          });
          fileStagingArea.addEventListener("click", (e) => {
            if (e.target.matches(".remove-file-btn")) {
              const index = parseInt(e.target.dataset.index);
              stagedFiles.splice(index, 1);
              renderStagedFiles();
            }
          });
          chatWindow.addEventListener("click", (e) => {
            const button = e.target.closest("[data-action]");
            if (button) {
              const action = button.dataset.action;
              button.parentElement.querySelectorAll("button").forEach((btn) => {
                btn.style.opacity = "0.5";
                btn.style.pointerEvents = "none";
              });
              switch (action) {
                case "analyzeSyllabus":
                  chatState = "awaitingSyllabus";
                  addMessageToChat(
                    "ai",
                    `<p>Great! Please upload your course syllabus (PDF or DOCX).<br><small style="color: var(--text-secondary);">You can also press <b>Ctrl+U</b> to open the file selector.</small></p>`
                  );
                  break;
                case "createStudyGuide":
                  chatState = "awaitingStudyGuideFiles";
                  addMessageToChat(
                    "ai",
                    `<p>Excellent choice. Upload your syllabus, notes, and lecture slides. When you're ready, press Send.<br><small style="color: var(--text-secondary);">You can also press <b>Ctrl+U</b> to open the file selector.</small></p>`
                  );
                  break;
                case "transcribeMedia":
                  chatState = "awaitingMedia";
                  addMessageToChat(
                    "ai",
                    `<p>Okay, please upload an audio or video file to transcribe.<br><small style="color: var(--text-secondary);">You can also press <b>Ctrl+U</b> to open the file selector.</small></p>`
                  );
                  break;
                case "askQuestion":
                  chatState = "idle";
                  addMessageToChat(
                    "ai",
                    `<p>Of course, what's on your mind?</p>`
                  );
                  break;
              }
            }
          });
          document.addEventListener("keydown", (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === "u") {
              e.preventDefault();
              fileUploadInput.click();
            }
            const modifier = isMac ? e.metaKey : e.altKey;
            if (modifier && e.key.toLowerCase() === "k") {
              e.preventDefault();
              toggleCalendar();
            }
            if (modifier && e.key.toLowerCase() === "c") {
              e.preventDefault();
              chatInput.focus();
            }
          });
          mainDashboard.addEventListener("keydown", (e) => {
            if (e.key !== "Tab") return;
            const focusableElementsSelector =
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            let focusableElements = Array.from(
              mainDashboard.querySelectorAll(focusableElementsSelector)
            );
            focusableElements = focusableElements.filter((el) => {
              const style = window.getComputedStyle(el);
              return (
                style.display !== "none" &&
                style.visibility !== "hidden" &&
                !el.disabled
              );
            });
            if (focusableElements.length === 0) return;
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            if (e.shiftKey) {
              if (document.activeElement === firstElement) {
                lastElement.focus();
                e.preventDefault();
              }
            } else {
              if (document.activeElement === lastElement) {
                firstElement.focus();
                e.preventDefault();
              }
            }
          });
          googleSignInBtn.addEventListener("click", () => {
            isGoogleSignedIn = true;
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            mockCalendarEvents = [
              {
                summary: "Team Project Meeting",
                start: { dateTime: today.toISOString() },
              },
              {
                summary: "CS-101 Lecture",
                start: { dateTime: tomorrow.toISOString() },
              },
              {
                summary: "Essay Draft Due",
                start: { date: nextWeek.toISOString().split("T")[0] },
              },
            ];
            updateCalendarView();
            renderCalendarGrid();
            renderCalendarEvents();
          });
          googleSignOutBtn.addEventListener("click", () => {
            isGoogleSignedIn = false;
            mockCalendarEvents = [];
            updateCalendarView();
          });
          prevMonthBtn.addEventListener("click", () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            renderCalendarGrid();
          });
          nextMonthBtn.addEventListener("click", () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            renderCalendarGrid();
          });

          showInitialPrompt();
        }

        // --- App Start ---
        window.initializeAppAPIs = function () {
          if (appInitialized) return;
          if (gapiReady && gisReady) {
            appInitialized = true;
            initializeGapiClientMock();
          }
        };

        if (loadPreferences()) {
          applyPreferences();
          mainDashboard.classList.remove("hidden");
          initializeMainApp();
        } else {
          welcomeWizard.classList.remove("hidden");
          wizardContent.orb.focus();
        }
        const startSetup = () => {
          wizardContent.orb.style.transform = "scale(0)";
          wizardContent.orb.style.opacity = "0";
          wizardContent.orb.removeEventListener("click", startSetup);
          wizardContent.orb.removeEventListener("keydown", handleOrbKeydown);
          wizardContent.keyboardHint.classList.remove("hidden");
          setTimeout(renderWizardStep, 300);
        };
        const handleOrbKeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            startSetup();
          }
        };
        welcomeWizard.addEventListener("keydown", (e) => {
          if (e.key === "Tab") {
            if (currentStep > 0) return;
            if (document.activeElement === wizardContent.orb) {
              e.preventDefault();
            }
          }
        });
        wizardContent.orb.addEventListener("click", startSetup);
        wizardContent.orb.addEventListener("keydown", handleOrbKeydown);
        const finishAction = () => {
          saveAndApplyPreferences();
          welcomeWizard.style.opacity = "0";
          setTimeout(() => {
            welcomeWizard.classList.add("hidden");
            mainDashboard.classList.remove("hidden");
            mainDashboard.classList.add("animate-fadeIn");
            initializeMainApp();
          }, 500);
        };
        wizardContent.finishBtn.onclick = finishAction;
        wizardContent.finishBtn.onkeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            finishAction();
          }
          if (e.key === "Tab") {
            e.preventDefault();
          }
        };

        initializeGapiClientMock();
      });
    </script>
  </body>
</html>
