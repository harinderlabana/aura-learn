<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura: The Accessibility Layer</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script src="https://unpkg.com/@arcadeai/arcadejs/dist/bundle.js"></script>

    <style>
      :root {
        --font-main: "Inter", sans-serif;
        --font-brand: "Poppins", sans-serif;

        /* Daylight Theme (Default) */
        --bg-color: #f5f5f7;
        --spotlight-1: rgba(0, 122, 255, 0.15);
        --spotlight-2: rgba(100, 180, 255, 0.15);
        --text-primary: #1d1d1f;
        --text-secondary: #86868b;
        --glass-bg: rgba(245, 245, 247, 0.85);
        --glass-border: rgba(0, 0, 0, 0.08);
        --accent: #007aff;
        --accent-hover: #0062cc;
        --accent-glow: 0 0 40px rgba(0, 122, 255, 0.4);
        --card-bg: #ffffff;
        --card-bg-hover: #f0f0f2;
        --user-bubble-bg: #007aff;
        --aura-bubble-bg: #e5e5ea;
      }

      .theme-dusk {
        --bg-color: #161618;
        --spotlight-1: rgba(0, 122, 255, 0.2);
        --spotlight-2: rgba(0, 224, 255, 0.2);
        --text-primary: #f5f5f7;
        --text-secondary: #a1a1a6;
        --glass-bg: rgba(22, 22, 24, 0.85);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent: #007aff;
        --accent-hover: #3395ff;
        --accent-glow: 0 0 40px rgba(0, 122, 255, 0.5);
        --card-bg: #1d1d1f;
        --card-bg-hover: #2c2c2e;
        --user-bubble-bg: #007aff;
        --aura-bubble-bg: #2c2c2e;
      }

      .theme-daylight {
        --bg-color: #f5f5f7;
        --spotlight-1: rgba(0, 122, 255, 0.15);
        --spotlight-2: rgba(100, 180, 255, 0.15);
        --text-primary: #1d1d1f;
        --text-secondary: #86868b;
        --glass-bg: rgba(245, 245, 247, 0.85);
        --glass-border: rgba(0, 0, 0, 0.08);
        --accent: #007aff;
        --accent-hover: #0062cc;
        --accent-glow: 0 0 40px rgba(0, 122, 255, 0.4);
        --card-bg: #ffffff;
        --card-bg-hover: #f0f0f2;
        --user-bubble-bg: #007aff;
        --aura-bubble-bg: #e5e5ea;
      }

      .theme-focus {
        --bg-color: #000000;
        --spotlight-1: rgba(252, 238, 10, 0.1);
        --spotlight-2: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --text-secondary: #f0f0f0;
        --glass-bg: #000000;
        --glass-border: #fcee0a;
        --accent: #fcee0a;
        --accent-hover: #ffff33;
        --accent-glow: 0 0 40px rgba(252, 238, 10, 0.9);
        --card-bg: #000000;
        --card-bg-hover: #1c1c1c;
        --user-bubble-bg: #000000;
        --aura-bubble-bg: #000000;
      }
      .theme-focus .glass-card,
      .theme-focus .option-card-inner,
      .theme-focus .aura-message,
      .theme-focus .user-message,
      .theme-focus kbd,
      .theme-focus .btn-task,
      .theme-focus .btn-preset {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border: 2px solid var(--accent);
      }
      .theme-focus .btn-primary,
      .theme-focus .user-message,
      .theme-focus .btn-preset.active {
        color: #000;
      }
      .theme-focus .btn-primary,
      .theme-focus .btn-task,
      .theme-focus .btn-preset {
        border: 2px solid var(--accent);
      }
      .theme-focus .user-message {
        border-color: var(--accent);
        color: #000;
      }
      .theme-focus .aura-message {
        border-color: var(--text-secondary);
      }

      .font-size-small {
        --font-scale: 0.9;
      }
      .font-size-medium {
        --font-scale: 1;
      }
      .font-size-large {
        --font-scale: 1.1;
      }

      body {
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-primary);
        overflow: hidden;
        transition: background-color 0.5s ease, color 0.5s ease,
          font-size 0.3s ease;
        font-size: calc(16px * var(--font-scale));
      }

      .font-brand {
        font-family: var(--font-brand);
      }
      .font-heading {
        font-family: var(--font-main);
        font-weight: 800;
        letter-spacing: -0.04em;
      }

      .spotlight {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        background: radial-gradient(
            circle at var(--x) var(--y),
            var(--spotlight-1) 0%,
            transparent 25%
          ),
          radial-gradient(
            circle at var(--x2) var(--y2),
            var(--spotlight-2) 0%,
            transparent 30%
          );
        transition: background 0.5s ease;
      }

      #main-wrapper {
        transition: filter 0.4s ease;
      }
      .filter-protanopia {
        filter: url(#protanopia);
      }
      .filter-deuteranopia {
        filter: url(#deuteranopia);
      }
      .filter-tritanopia {
        filter: url(#tritanopia);
      }

      .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(32px);
        -webkit-backdrop-filter: blur(32px);
        transition: all 0.3s ease;
      }

      .btn-primary {
        background-color: var(--accent);
        color: white;
        transition: all 0.3s ease;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: var(--accent-hover);
        transform: scale(1.03);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .btn-primary:disabled {
        background-color: var(--card-bg-hover);
        color: var(--text-secondary);
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: var(--card-bg-hover);
        color: var(--text-primary);
        border-color: var(--glass-border);
      }
      .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      kbd {
        background-color: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.875rem;
        transition: all 0.3s ease;
      }

      .onboarding-step {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.6s ease, visibility 0.6s;
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .onboarding-step.active {
        opacity: 1;
        visibility: visible;
      }

      @keyframes enter-anim {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .animate-enter {
        animation: enter-anim 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      }

      .aura-message,
      .user-message {
        padding: 0.75rem 1.25rem;
        transition: all 0.3s ease;
        line-height: 1.6;
      }
      .user-message {
        background-color: var(--user-bubble-bg);
        color: white;
      }
      .aura-message {
        background-color: var(--aura-bubble-bg);
      }

      .tts-player {
        opacity: 1;
        height: 40px;
        background: rgba(0, 0, 0, 0.05);
        padding: 4px 8px;
        border-radius: 99px;
        display: flex;
        align-items: center;
        width: 100%;
      }
      .theme-dusk .tts-player {
        background: rgba(255, 255, 255, 0.05);
      }
      .tts-player button,
      .tts-player a {
        color: var(--text-secondary);
      }
      .tts-player button:hover:not(:disabled),
      .tts-player a:hover {
        color: var(--text-primary);
      }
      .tts-player button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      input[type="range"].tts-progress-bar {
        -webkit-appearance: none;
        background: transparent;
        cursor: pointer;
        width: 100%;
      }
      input[type="range"].tts-progress-bar::-webkit-slider-runnable-track {
        height: 4px;
        background: var(--text-secondary);
        opacity: 0.3;
        border-radius: 2px;
      }
      input[type="range"].tts-progress-bar::-moz-range-track {
        height: 4px;
        background: var(--text-secondary);
        opacity: 0.3;
        border-radius: 2px;
      }
      input[type="range"].tts-progress-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        margin-top: -4px;
        background-color: var(--accent);
        height: 12px;
        width: 12px;
        border-radius: 50%;
      }
      input[type="range"].tts-progress-bar::-moz-range-thumb {
        border: none;
        border-radius: 50%;
        background-color: var(--accent);
        height: 12px;
        width: 12px;
      }

      .aura-message h3 {
        font-size: 1.1em;
        font-weight: 700;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        padding-bottom: 0.25rem;
        border-bottom: 1px solid var(--glass-border);
      }
      .aura-message h3:first-child {
        margin-top: 0.25rem;
      }
      .aura-message ul {
        list-style-type: disc;
        padding-left: 1.75rem;
        margin: 0.75rem 0;
      }
      .aura-message li {
        margin-bottom: 0.5rem;
      }
      .aura-message p {
        margin-bottom: 0.75rem;
      }
      .aura-message p:last-child {
        margin-bottom: 0;
      }
      .aura-message strong {
        font-weight: 600;
        color: var(--text-primary);
      }

      #chat-input {
        transition: height 0.2s ease-in-out, border-radius 0.2s ease-in-out;
      }

      /* High-Visibility Focus Ring */
      *:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px var(--accent);
        border-radius: 8px;
        transition: box-shadow 0.2s ease-in-out;
      }
      .option-card:focus-visible {
        box-shadow: none;
      } /* Handled by inner element */
      .option-card-inner {
        transition: transform 0.3s ease, box-shadow 0.3s ease,
          border-color 0.3s ease, background-color 0.3s ease;
      }
      .option-card:focus-visible .option-card-inner {
        transform: scale(1.03);
        box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px var(--accent);
      }

      .btn-task {
        background-color: var(--card-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      .btn-task:hover:not(:disabled) {
        background-color: var(--accent);
        color: white;
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .btn-task:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-preset {
        background-color: var(--card-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-secondary);
        transition: all 0.3s ease;
      }
      .btn-preset:hover,
      .btn-preset.active {
        background-color: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      @keyframes doc-anim {
        0% {
          transform: translateY(2px);
        }
        50% {
          transform: translateY(-2px);
        }
        100% {
          transform: translateY(2px);
        }
      }
      .doc-icon-anim {
        animation: doc-anim 1.5s ease-in-out infinite;
      }

      @keyframes fill-in {
        from {
          background-size: 0% 100%;
          color: var(--text-primary);
        }
        to {
          background-size: 100% 100%;
          color: white;
        }
      }

      .animate-fill-in {
        background-image: linear-gradient(
          to right,
          var(--accent),
          var(--accent)
        );
        background-repeat: no-repeat;
        background-position: 0 0;
        animation: fill-in 1.2s ease-out forwards;
      }
    </style>
  </head>
  <body class="antialiased">
    <div id="main-wrapper">
      <div class="sr-only" aria-live="polite" id="sr-announcer"></div>

      <div class="spotlight"></div>

      <div
        id="notification"
        class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-3 rounded-full text-sm font-semibold shadow-lg glass-card opacity-0 -translate-y-10 transition-all duration-300 ease-in-out z-50"
      >
        Copied to clipboard!
      </div>

      <div
        id="onboarding-container"
        class="relative w-full h-screen p-6 sm:p-8"
      >
        <div class="w-full max-w-7xl mx-auto flex flex-col h-full">
          <header
            class="flex-shrink-0 animate-enter"
            style="animation-delay: 0s"
          >
            <h1 class="font-brand text-xl tracking-widest text-text-primary">
              AURA
            </h1>
          </header>
          <main class="flex-grow flex flex-col justify-center relative"></main>
          <footer class="flex-shrink-0">
            <div
              id="onboarding-nav"
              class="animate-enter"
              style="animation-delay: 0.3s"
            >
              <div class="flex justify-center items-center gap-6 mb-4">
                <button
                  id="back-btn"
                  class="btn-secondary px-6 py-3 rounded-xl font-semibold hidden"
                >
                  Back
                </button>
                <div id="progress-dots" class="flex gap-3">
                  <span class="w-2.5 h-2.5 bg-white/20 rounded-full"></span>
                  <span class="w-2.5 h-2.5 bg-white/20 rounded-full"></span>
                  <span class="w-2.5 h-2.5 bg-white/20 rounded-full"></span>
                  <span class="w-2.5 h-2.5 bg-white/20 rounded-full"></span>
                </div>
                <button
                  id="next-btn"
                  class="btn-primary px-6 py-3 rounded-xl font-semibold"
                  disabled
                >
                  Next
                </button>
              </div>
              <div
                class="kbd-legend hidden md:block text-center text-text-secondary"
              >
                Use <kbd>Tab</kbd> to navigate and <kbd>Enter</kbd> to select.
              </div>
            </div>
          </footer>
        </div>
      </div>

      <div id="dashboard-container" class="w-full h-screen flex-col hidden">
        <header
          class="w-full p-4 flex justify-between items-center glass-card border-t-0 border-x-0 rounded-none z-20 flex-shrink-0 animate-enter"
        >
          <h1 class="font-brand text-2xl tracking-widest">AURA</h1>
          <div class="flex items-center gap-4">
            <button
              id="download-btn"
              class="btn-secondary text-sm px-4 py-2 rounded-lg font-semibold hidden items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Download Transcript
            </button>
            <button id="settings-btn" aria-label="Open settings">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-text-secondary hover:text-text-primary transition-colors"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </button>
          </div>
        </header>
        <main
          id="chat-container"
          class="flex-grow p-4 md:p-6 overflow-y-auto w-full max-w-3xl mx-auto animate-enter"
          style="animation-delay: 0.1s"
        ></main>
        <footer
          class="w-full p-4 md:p-6 flex-shrink-0 animate-enter"
          style="animation-delay: 0.2s"
        >
          <div id="chat-form" class="w-full max-w-3xl mx-auto">
            <div id="file-info" class="mb-2"></div>
            <div class="relative">
              <textarea
                id="chat-input"
                rows="1"
                placeholder="Type a message..."
                class="w-full pl-12 pr-14 py-3 rounded-full glass-card text-text-primary placeholder:text-text-secondary focus:outline-none transition-all text-base resize-none overflow-y-hidden"
              ></textarea>
              <label
                for="file-upload"
                class="absolute left-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-[var(--card-bg-hover)] cursor-pointer"
              >
                <svg
                  class="w-6 h-6 text-text-secondary"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"
                  ></path>
                </svg>
                <input
                  type="file"
                  id="file-upload"
                  class="hidden"
                  accept=".txt,.pdf,.docx,.mp3,.mp4,.m4a"
                />
              </label>
              <button
                type="submit"
                id="send-btn"
                aria-label="Send message"
                class="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 rounded-full bg-[var(--accent)] text-white hover:bg-[var(--accent-hover)] transition-all duration-300 transform hover:scale-1.05"
              >
                <svg
                  class="w-5 h-5 -rotate-45"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M22 2L11 13"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M22 2L15 22L11 13L2 9L22 2Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </div>
            <div
              class="kbd-legend hidden md:flex justify-center items-center gap-4 text-text-secondary text-xs mt-2"
            >
              <span><kbd>Tab</kbd> Navigate</span>
              <span><kbd>Enter</kbd> Select/Send</span>
              <span><kbd>/</kbd> Focus Chat</span>
              <span><kbd>Cmd+U</kbd> Upload</span>
            </div>
          </div>
        </footer>
      </div>

      <div
        id="settings-modal"
        class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center"
      >
        <div
          id="settings-modal-content"
          class="glass-card rounded-2xl w-full max-w-3xl p-6 md:p-8 m-4 animate-enter"
        ></div>
      </div>
    </div>

    <svg width="0" height="0" class="absolute">
      <defs>
        <filter id="protanopia">
          <feColorMatrix
            type="matrix"
            values="0.567,0.433,0,0,0  0.558,0.442,0,0,0  0,0.242,0.758,0,0  0,0,0,1,0"
          />
        </filter>
        <filter id="deuteranopia">
          <feColorMatrix
            type="matrix"
            values="0.625,0.375,0,0,0  0.7,0.3,0,0,0  0,0.3,0.7,0,0  0,0,0,1,0"
          />
        </filter>
        <filter id="tritanopia">
          <feColorMatrix
            type="matrix"
            values="0.95,0.05,0,0,0  0,0.433,0.567,0,0  0,0.475,0.525,0,0  0,0,0,1,0"
          />
        </filter>
      </defs>
    </svg>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // API Keys will be loaded from the server
        let GEMINI_API_KEY;
        let ARCADE_API_KEY;

        let currentStep = 1;
        let userSelections = {
          theme: null,
          fontSize: null,
          colorVision: null,
          readingLevel: null,
        };
        let chatHistory = [];
        let isAuraTyping = false;
        let currentAudio = null;
        let activeTTSPlayer = null;
        let activeTrap = null;
        let uploadedFile = null;
        let activeTask = null;
        let arcadeClient = null;

        // Set the workerSrc for pdf.js
        if (window.pdfjsLib) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
        }

        const body = document.body;
        const mainWrapper = document.getElementById("main-wrapper");
        const spotlight = document.querySelector(".spotlight");
        const onboardingContainer = document.getElementById(
          "onboarding-container"
        );
        const dashboardContainer = document.getElementById(
          "dashboard-container"
        );
        const srAnnouncer = document.getElementById("sr-announcer");
        const notification = document.getElementById("notification");
        let notificationTimeout;
        const backBtn = document.getElementById("back-btn");
        const nextBtn = document.getElementById("next-btn");
        const progressDots = document.getElementById("progress-dots").children;
        const chatContainer = document.getElementById("chat-container");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const settingsBtn = document.getElementById("settings-btn");
        const settingsModal = document.getElementById("settings-modal");
        const settingsModalContent = document.getElementById(
          "settings-modal-content"
        );
        const downloadBtn = document.getElementById("download-btn");
        const fileUpload = document.getElementById("file-upload");
        const fileInfo = document.getElementById("file-info");
        const sendBtn = document.getElementById("send-btn");
        const mainOnboardingArea = onboardingContainer.querySelector("main");

        const onboardingData = {
          theme: {
            title: "Customize your experience.",
            description: "Start by selecting a theme.",
            options: [
              {
                id: "theme-daylight",
                name: "Daylight",
                description: "Clean and bright.",
                data: "daylight",
                icon: `<svg class="w-full h-auto" viewBox="0 0 120 90" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="90" rx="8" fill="#FFFFFF"/><rect x="12" y="12" width="96" height="10" rx="2" fill="#E5E5EA"/><rect x="12" y="28" width="60" height="8" rx="2" fill="#E5E5EA"/><circle cx="88" cy="55" r="15" fill="#007AFF"/><path d="M88 34V37M88 76V79M100.99 42.01L98.8688 44.1312M77.1312 65.8688L75.01 67.99M111 55H108M68 55H65M100.99 67.99L98.8688 65.8688M77.1312 44.1312L75.01 42.01" stroke="#007AFF" stroke-width="3" stroke-linecap="round"/></svg>`,
              },
              {
                id: "theme-dusk",
                name: "Dusk",
                description: "Easy on the eyes.",
                data: "dusk",
                icon: `<svg class="w-full h-auto" viewBox="0 0 120 90" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="90" rx="8" fill="#1D1D1F"/><rect x="12" y="12" width="96" height="10" rx="2" fill="#2C2C2E"/><rect x="12" y="28" width="60" height="8" rx="2" fill="#2C2C2E"/><path d="M98 70C106.284 70 113 63.2843 113 55C113 46.7157 106.284 40 98 40C95.8341 40 93.7737 40.4823 91.9442 41.3413C90.22 34.3315 83.9935 29 76.5 29C68.3223 29 61.5 35.8223 61.5 44C61.5 44.3333 61.5222 44.6625 61.5659 44.9866C60.0381 43.7634 58.0902 43 56 43C51.5817 43 48 46.5817 48 51" stroke="#007AFF" stroke-width="3" stroke-linecap="round"/></svg>`,
              },
              {
                id: "theme-focus",
                name: "Focus",
                description: "Maximum accessibility.",
                data: "focus",
                icon: `<svg class="w-full h-auto" viewBox="0 0 120 90" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="116" height="86" rx="6" fill="black" stroke="#FCEE0A" stroke-width="4"/><rect x="12" y="16" width="96" height="12" fill="#FCEE0A"/><rect x="12" y="39" width="96" height="12" fill="#FCEE0A"/><rect x="12" y="62" width="96" height="12" fill="#FCEE0A"/></svg>`,
              },
            ],
          },
          fontSize: {
            title: "Read with comfort.",
            description: "Select the font size that's easiest for you to read.",
            options: [
              {
                id: "font-size-small",
                name: "Small",
                data: "small",
                description: "For more content on screen.",
              },
              {
                id: "font-size-medium",
                name: "Medium",
                data: "medium",
                description: "A comfortable default.",
              },
              {
                id: "font-size-large",
                name: "Large",
                data: "large",
                description: "For maximum readability.",
              },
            ],
          },
          colorVision: {
            title: "Clarity for all eyes.",
            description: "Adjust colors for color vision deficiencies.",
            options: [
              {
                id: "filter-none",
                name: "None",
                description: "Standard color palette.",
                data: "none",
                icon: `<svg class="w-full h-auto" viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="20" height="50" fill="#ff4d4d"/><rect x="20" y="0" width="20" height="50" fill="#ffc700"/><rect x="40" y="0" width="20" height="50" fill="#4dff4d"/><rect x="60" y="0" width="20" height="50" fill="#4da6ff"/><rect x="80" y="0" width="20" height="50" fill="#a64dff"/></svg>`,
              },
              {
                id: "filter-protanopia",
                name: "Protanopia",
                description: "Adjusts for red-blindness.",
                data: "protanopia",
                icon: `<svg class="w-full h-auto" viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="20" height="50" fill="#908a34"/><rect x="20" y="0" width="20" height="50" fill="#f4db00"/><rect x="40" y="0" width="20" height="50" fill="#88c53c"/><rect x="60" y="0" width="20" height="50" fill="#008ce1"/><rect x="80" y="0" width="20" height="50" fill="#5c88e8"/></svg>`,
              },
              {
                id: "filter-deuteranopia",
                name: "Deuteranopia",
                description: "Adjusts for green-blindness.",
                data: "deuteranopia",
                icon: `<svg class="w-full h-auto" viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="20" height="50" fill="#a49b22"/><rect x="20" y="0" width="20" height="50" fill="#f8de00"/><rect x="40" y="0" width="20" height="50" fill="#a0c92d"/><rect x="60" y="0" width="20" height="50" fill="#299de2"/><rect x="80"y="0" width="20" height="50" fill="#759ce9"/></svg>`,
              },
              {
                id: "filter-tritanopia",
                name: "Tritanopia",
                description: "Adjusts for blue-blindness.",
                data: "tritanopia",
                icon: `<svg class="w-full h-auto" viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="20" height="50" fill="#ff5555"/><rect x="20" y="0" width="20" height="50" fill="#ffd000"/><rect x="40" y="0" width="20" height="50" fill="#00e573"/><rect x="60" y="0" width="20" height="50" fill="#00c4ff"/><rect x="80" y="0" width="20" height="50" fill="#e1a0ff"/></svg>`,
              },
            ],
          },
          readingLevel: {
            title: "Choose your reading level.",
            description: "Select the style of communication you prefer.",
            options: [
              {
                id: "level-simplified",
                name: "Simplified",
                data: "simplified",
                description: "Quick & direct answers.",
                exampleHTML: `<p class="text-xl font-medium text-center text-text-primary">The sky is blue.</p>`,
              },
              {
                id: "level-natural",
                name: "Natural",
                data: "natural",
                description: "Clear & thorough explanations.",
                exampleHTML: `<p class="text-xl font-medium text-center text-text-primary">The sky appears blue to us.</p>`,
              },
              {
                id: "level-complex",
                name: "Complex",
                data: "complex",
                description: "Technical & in-depth analysis.",
                exampleHTML: `<p class="text-xl font-medium text-center text-text-primary">The atmosphere scatters blue light more than other colors.</p>`,
              },
            ],
          },
        };

        const systemPrompts = {
          simplified:
            "You are Aura, a helpful AI assistant. Your responses must be concise, clear, and easy to understand. ALWAYS use markdown for formatting like lists, headings, and bold text. Use simple language and get straight to the point. Aim for responses under 50 words unless more detail is absolutely necessary.",
          natural:
            "You are Aura, a helpful AI assistant. Provide comprehensive, well-structured, and informative answers. ALWAYS use markdown for formatting like lists, headings, and bold text. Explain concepts thoroughly but in an accessible way. Use examples and analogies where helpful. Your tone is patient and knowledgeable.",
          complex:
            "You are Aura, a helpful AI assistant. You are communicating with an expert in their field. ALWAYS use markdown for formatting like lists, headings, and bold text. Use precise, technical language and assume a high level of domain knowledge. Do not oversimplify concepts. Your responses should be data-rich and sophisticated.",
        };

        const syllabusPrompts = {
          simplified: `You are an expert academic assistant. Structure your summary in the following order using markdown headings:
### Course Details
- List the course name and code.
### Instructor Contact
- List the professor and any TAs with their name and email.
### Assignments & Exams
- Create a single bulleted list.
- For each item (assignment, test, exam, etc.), combine its name, due date, and weight. When a specific date is found, format it like this: <time datetime='YYYY-MM-DD'>[Date]</time>. Example: **Assignment 1**: <time datetime='2025-09-26'>Sep 26, 2025</time> - **5%**
- Be concise and direct.`,
          natural: `You are a helpful academic assistant. Summarize the provided syllabus clearly. Structure your summary in the following order using markdown headings:
### Course Information
- List the course name and code.
### Instructor & TA Contact
- Provide names and contact information for the professor and TAs. Include office hours if available.
### Key Assessments & Dates
- Create a bulleted list.
- For each item, combine its name, due date, and weight. When a specific date is found, format it like this: <time datetime='YYYY-MM-DD'>[Date]</time>. Example: **Assessment 1**: <time datetime='2025-09-26'>Sep 26, 2025</time> - **(10%)**
- Include a brief, one-sentence description if necessary.
### Important Policies
- Briefly summarize any key policies like late submissions.`,
          complex: `You are an expert academic analyst. Provide a comprehensive and detailed summary of the provided syllabus. Structure your summary precisely as follows using markdown headings:
### Course & Instructor Logistics
- List the full course title, instructor names, all contact information (email, office location), and office hours.
### Assessment Schedule & Weighting
- Create a detailed bulleted list for all graded components.
- Each item must follow this format: **Component Name**: Due <time datetime='YYYY-MM-DD'>[Date]</time> - **(Weight %)**
- Include any specific details or requirements for each component.
### Detailed Policies
- Summarize policies on academic integrity, late submissions, and grading requirements in detail.`,
        };

        // --- ONBOARDING FUNCTIONS ---
        const applySettings = () => {
          body.className = "antialiased"; // Reset
          if (userSelections.theme)
            body.classList.add(`theme-${userSelections.theme}`);
          if (userSelections.fontSize)
            body.classList.add(`font-size-${userSelections.fontSize}`);
          mainWrapper.className = "";
          if (
            userSelections.colorVision &&
            userSelections.colorVision !== "none"
          )
            mainWrapper.classList.add(`filter-${userSelections.colorVision}`);
        };
        const handlePreview = (type, value) => {
          if (type === "theme") {
            body.classList.remove(
              "theme-dusk",
              "theme-daylight",
              "theme-focus"
            );
            body.classList.add(`theme-${value}`);
          } else if (type === "fontSize") {
            body.classList.remove(
              "font-size-small",
              "font-size-medium",
              "font-size-large"
            );
            body.classList.add(`font-size-${value}`);
          } else if (type === "colorVision") {
            mainWrapper.className = "";
            if (value !== "none") mainWrapper.classList.add(`filter-${value}`);
          }
        };
        const removePreview = () => applySettings();
        const handleSelection = (selectedCard, type, value) => {
          const parent = selectedCard.parentElement;
          parent.querySelectorAll(".option-card").forEach((card) => {
            card.classList.remove("selected");
            card.setAttribute("aria-checked", "false");
            card
              .querySelector(".checkmark")
              .classList.add("opacity-0", "scale-50");
          });
          selectedCard.classList.add("selected");
          selectedCard.setAttribute("aria-checked", "true");
          selectedCard
            .querySelector(".checkmark")
            .classList.remove("opacity-0", "scale-50");
          userSelections[type] = value;
          applySettings();
          nextBtn.disabled = false;
          setTimeout(() => nextBtn.focus(), 100);
        };
        const createOptionCard = (option, type) => {
          const card = document.createElement("div");
          card.className = "option-card cursor-pointer focus:outline-none";
          card.setAttribute("tabindex", "0");
          card.setAttribute("role", "radio");
          card.dataset.type = type;
          card.dataset.value = option.data;

          let contentHTML = "";
          if (option.icon)
            contentHTML = `<div class="flex-grow flex items-center justify-center min-h-[120px]">${option.icon}</div>`;
          else if (option.exampleHTML)
            contentHTML = `<div class="flex-grow flex items-center justify-center min-h-[120px] p-4">${option.exampleHTML}</div>`;
          else if (type === "fontSize")
            contentHTML = `<div class="flex-grow flex items-center justify-center min-h-[120px]"><span class="font-heading text-4xl" style="font-size: ${
              option.data === "small"
                ? "1.5rem"
                : option.data === "medium"
                ? "2rem"
                : "2.5rem"
            }">Aa</span></div>`;

          card.innerHTML = `<div class="option-card-inner rounded-2xl h-full flex flex-col justify-between text-left p-4 md:p-5 relative"><div class="flex justify-end"><div class="checkmark opacity-0 scale-50 text-[var(--accent)]"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.25 8.25L10.5 15L6.75 11.25" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>${contentHTML}<div><h3 class="font-semibold text-base md:text-lg text-text-primary mt-4">${option.name}</h3><p class="text-sm text-text-secondary">${option.description}</p></div></div>`;

          card.addEventListener("mouseenter", () =>
            handlePreview(type, option.data)
          );
          card.addEventListener("focus", () =>
            handlePreview(type, option.data)
          );
          card.addEventListener("mouseleave", removePreview);
          card.addEventListener("blur", removePreview);
          card.addEventListener("click", () =>
            handleSelection(card, type, option.data)
          );
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handleSelection(card, type, option.data);
            }
          });
          return card;
        };
        const createStepElement = (stepIndex) => {
          const stepKey = Object.keys(onboardingData)[stepIndex - 1];
          const stepInfo = onboardingData[stepKey];
          const stepDiv = document.createElement("div");
          stepDiv.id = `step-${stepIndex}`;
          stepDiv.className = "onboarding-step w-full";
          const cardGridCols =
            stepInfo.options.length > 3 ? 4 : stepInfo.options.length;
          stepDiv.innerHTML = `<div class="w-full max-w-5xl text-left animate-enter"><h2 class="font-heading text-5xl md:text-7xl mb-4" style="animation-delay: 0.1s;">${stepInfo.title}</h2><p class="text-lg md:text-xl text-text-secondary mb-12 max-w-2xl" style="animation-delay: 0.2s;">${stepInfo.description}</p><div class="grid grid-cols-1 md:grid-cols-${cardGridCols} gap-4 md:gap-6" style="animation-delay: 0.3s;"></div></div>`;
          const grid = stepDiv.querySelector(".grid");
          stepInfo.options.forEach((option) =>
            grid.appendChild(createOptionCard(option, stepKey))
          );
          return stepDiv;
        };
        const showStep = (stepNumber) => {
          document
            .querySelectorAll(".onboarding-step")
            .forEach((step, index) =>
              step.classList.toggle("active", index + 1 === stepNumber)
            );
          backBtn.classList.toggle("hidden", stepNumber === 1);
          nextBtn.textContent = stepNumber === 4 ? "Start Aura" : "Next";
          nextBtn.disabled =
            userSelections[Object.keys(userSelections)[stepNumber - 1]] ===
            null;
          Array.from(progressDots).forEach((dot, index) => {
            dot.classList.toggle("bg-[var(--accent)]", index < stepNumber);
            dot.classList.toggle("bg-white/20", index >= stepNumber);
          });
          trapFocus(onboardingContainer);
          const activeStepElement = document.getElementById(
            `step-${stepNumber}`
          );
          if (activeStepElement) {
            const firstCard = activeStepElement.querySelector(".option-card");
            if (firstCard) {
              setTimeout(() => firstCard.focus(), 100);
            }
          }
        };
        const startDashboard = () => {
          removeTrap();
          onboardingContainer.style.opacity = "0";
          setTimeout(() => {
            onboardingContainer.remove();
            dashboardContainer.classList.remove("hidden");
            dashboardContainer.classList.add("flex");

            const welcomeMessageHTML = getWelcomeMessageHTML();
            // Render the message with buttons, but don't add its messy text to history
            addChatMessage("model", welcomeMessageHTML, false, false);

            // Manually create clean text and add it to history
            const welcomeText =
              "Hello! I'm Aura, your personal AI assistant. I'm here to help you with your studies. What can I do for you today?";
            chatHistory.push({ role: "model", parts: [{ text: welcomeText }] });

            trapFocus(dashboardContainer);
          }, 600);
        };

        // --- CHAT & AI FUNCTIONS ---
        const getWelcomeMessageHTML = () => {
          return `
                <p class="mb-4">Hello! I'm Aura, your personal AI assistant. I'm here to help you with your studies. What can I do for you today?</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2" id="task-buttons">
                    <button class="btn-task p-3 rounded-lg text-sm font-semibold flex items-center justify-center gap-2" data-task="summarize-syllabus">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        Summarize Syllabus
                    </button>
                    <button class="btn-task p-3 rounded-lg text-sm font-semibold flex items-center justify-center gap-2" data-task="summarize-slides">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        Summarize Slides
                    </button>
                    <button class="btn-task p-3 rounded-lg text-sm font-semibold flex items-center justify-center gap-2" data-task="transcribe-media">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        Transcribe Media
                    </button>
                </div>
            `;
        };
        const addChatMessage = (
          role,
          message,
          withTTS = true,
          addToHistory = true
        ) => {
          const isAura = role.toLowerCase() !== "user";

          // Create the main wrapper for the entire message entry
          const entryWrapper = document.createElement("div");
          entryWrapper.className = `w-full flex flex-col mb-4 animate-enter ${
            isAura ? "items-start" : "items-end"
          }`;

          // Create the message bubble
          const messageDiv = document.createElement("div");
          const bubbleClass = isAura ? "aura-message" : "user-message";
          messageDiv.className = `rounded-2xl ${bubbleClass}`;
          messageDiv.innerHTML = `<div class="message-content">${message}</div>`;

          // Add the bubble to the wrapper
          entryWrapper.appendChild(messageDiv);

          // If it's an Aura message, create and add the controls below the bubble
          if (isAura && withTTS) {
            const textContent = message.replace(/<[^>]*>/g, "");
            const controlsDiv = document.createElement("div");
            controlsDiv.className = "flex items-center gap-2 mt-2";
            controlsDiv.innerHTML = `
                    <div class="tts-player-container flex-grow">
                        <div class="tts-player" data-text="${textContent}">
                            </div>
                    </div>
                    <button class="copy-btn p-2 rounded-full hover:bg-[rgba(0,0,0,0.1)] transition-colors" aria-label="Copy response">
                       <svg class="w-5 h-5 text-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                    `;
            entryWrapper.appendChild(controlsDiv);
            resetTTSPlayer(controlsDiv.querySelector(".tts-player"));
          }

          // Add the entire entry to the chat container
          chatContainer.appendChild(entryWrapper);
          chatContainer.scrollTop = chatContainer.scrollHeight;

          // Handle chat history
          if (addToHistory) {
            if (role === "user") {
              chatHistory.push({
                role: "user",
                parts: [
                  { text: message.replace(/<br><small.*<\/small>/g, "") },
                ],
              });
              if (!uploadedFile) getAuraResponse();
            } else if (role === "model") {
              // Store the raw markdown for PDF generation
              chatHistory.push({ role: "model", parts: [{ text: message }] });
            }
          }

          // Show/hide download button and animate its appearance
          const wasHidden = downloadBtn.classList.contains("hidden");
          downloadBtn.classList.toggle("hidden", chatHistory.length < 2);
          downloadBtn.classList.toggle("flex", chatHistory.length >= 2);
          const isVisible = !downloadBtn.classList.contains("hidden");

          if (wasHidden && isVisible) {
            downloadBtn.classList.add("animate-fill-in");
            downloadBtn.addEventListener(
              "animationend",
              () => {
                // Keep the final state of the animation
              },
              { once: true }
            );
          }
        };
        const showTypingIndicator = (message = "") => {
          if (isAuraTyping) return;
          isAuraTyping = true;
          const wrapper = document.createElement("div");
          wrapper.className = "flex justify-start mb-4 animate-enter";
          wrapper.id = "typing-indicator";
          const docIcon = `<svg class="w-5 h-5 text-text-secondary doc-icon-anim" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>`;
          const typingDots = `<div class="w-2 h-2 bg-text-secondary rounded-full animate-bounce"></div><div class="w-2 h-2 bg-text-secondary rounded-full animate-bounce" style="animation-delay:0.2s"></div><div class="w-2 h-2 bg-text-secondary rounded-full animate-bounce" style="animation-delay:0.4s"></div>`;

          wrapper.innerHTML = `<div class="aura-message rounded-2xl p-4 flex items-center gap-2">${
            message ? docIcon : typingDots
          }<span class="text-text-secondary ml-2 text-sm">${message}</span></div>`;
          chatContainer.appendChild(wrapper);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        const hideTypingIndicator = () => {
          const indicator = document.getElementById("typing-indicator");
          if (indicator) indicator.remove();
          isAuraTyping = false;
        };

        async function callGeminiAPI(payload, isMedia = false) {
          const textModels = [
            "gemini-1.5-flash-latest",
            "gemini-2.5-flash",
            "gemini-pro",
          ];
          const mediaModels = ["gemini-1.5-flash-latest"]; // Only this model supports inline media
          const modelsToTry = isMedia ? mediaModels : textModels;

          let lastError = null;

          for (const model of modelsToTry) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;

            for (let i = 0; i < 3; i++) {
              // Retry loop with exponential backoff
              try {
                const response = await fetch(apiUrl, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                });

                if (response.ok) {
                  const result = await response.json();
                  return (
                    result.candidates?.[0]?.content?.parts?.[0]?.text ||
                    "I'm not sure how to respond to that."
                  );
                }

                if (response.status === 429) {
                  // Rate limit error, wait and retry
                  const delay = 4000 * 2 ** i + Math.random() * 1000;
                  console.log(
                    `Rate limited on ${model}. Retrying in ${delay}ms...`
                  );
                  await new Promise((res) => setTimeout(res, delay));
                  continue; // Continue to the next retry attempt
                }

                // For other errors (like 404), we break the retry loop and try the next model.
                throw new Error(
                  `API Error: ${response.status} with model ${model}`
                );
              } catch (error) {
                lastError = error;
                // If it's not a rate limit error, break from retries and try the next model.
                if (!error.message.includes("429")) {
                  break;
                }
                // If it is a rate limit error and it's the last retry, the outer loop will proceed to the next model.
              }
            }
          }

          // If all models and retries fail
          console.error("All models and retries failed.", lastError);
          throw lastError || new Error("All AI models failed to respond.");
        }
        async function getAuraResponse() {
          showTypingIndicator();
          try {
            // We need to send clean text to the API
            const cleanHistory = chatHistory.map((m) => ({
              role: m.role,
              parts: [
                {
                  text: m.parts[0].text
                    .replace(/<[^>]*>/g, " ")
                    .replace(/\s+/g, " ")
                    .trim(),
                },
              ],
            }));

            const payload = {
              contents: cleanHistory,
              systemInstruction: {
                parts: [{ text: systemPrompts[userSelections.readingLevel] }],
              },
            };

            const responseText = await callGeminiAPI(payload); // Raw Markdown
            chatHistory.push({
              role: "model",
              parts: [{ text: responseText }],
            }); // Store raw markdown

            const formattedHtml = formatAIResponse(responseText);
            addChatMessage("model", formattedHtml, true, false); // Display HTML, don't add to history again
          } catch (error) {
            addChatMessage(
              "Aura",
              "I'm sorry, I'm having trouble connecting right now. Please try again.",
              false
            );
          } finally {
            hideTypingIndicator();
          }
        }

        // --- UTILITY & FOCUS FUNCTIONS ---
        const handleFocusTrap = (e) => {
          if (!activeTrap || e.key !== "Tab") return;

          let focusableElements;
          const inOnboarding =
            onboardingContainer &&
            onboardingContainer.contains(document.activeElement);

          if (inOnboarding && nextBtn.disabled) {
            const activeStep = activeTrap.querySelector(
              ".onboarding-step.active"
            );
            focusableElements = activeStep
              ? Array.from(activeStep.querySelectorAll(".option-card"))
              : [];
          } else {
            focusableElements = Array.from(
              activeTrap.querySelectorAll(
                'a, button, input, textarea, [tabindex]:not([tabindex="-1"])'
              )
            ).filter(
              (el) =>
                el.offsetParent !== null &&
                !el.disabled &&
                el.getClientRects().length > 0
            );
          }

          if (focusableElements.length === 0) {
            e.preventDefault();
            return;
          }

          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];

          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              lastElement.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastElement) {
              firstElement.focus();
              e.preventDefault();
            }
          }
        };

        const trapFocus = (element) => {
          if (activeTrap)
            document.removeEventListener("keydown", handleFocusTrap);
          activeTrap = element;
          document.addEventListener("keydown", handleFocusTrap);
        };
        const removeTrap = () => {
          document.removeEventListener("keydown", handleFocusTrap);
          activeTrap = null;
        };

        // --- SETTINGS MODAL FUNCTIONS ---
        const openSettingsModal = () => {
          settingsModalContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="font-heading text-3xl">Settings</h2><button id="close-modal-btn" aria-label="Close settings"><svg class="w-7 h-7 text-text-secondary hover:text-text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`;
          const contentDiv = document.createElement("div");
          contentDiv.className = "space-y-6";
          Object.keys(onboardingData).forEach((key) =>
            contentDiv.appendChild(
              createSettingControl(key, onboardingData[key])
            )
          );
          settingsModalContent.appendChild(contentDiv);
          settingsModal.classList.remove("hidden");
          settingsModal.classList.add("flex");
          const closeBtn =
            settingsModalContent.querySelector("#close-modal-btn");
          closeBtn.addEventListener("click", closeSettingsModal);
          trapFocus(settingsModal);
          closeBtn.focus();
        };
        const closeSettingsModal = () => {
          settingsModal.classList.add("hidden");
          settingsModal.classList.remove("flex");
          removeTrap();
          settingsBtn.focus();
          if (dashboardContainer.offsetParent !== null)
            trapFocus(dashboardContainer);
        };
        const createSettingControl = (type, data) => {
          const container = document.createElement("div");
          container.innerHTML = `<label class="block text-text-secondary mb-2 text-sm capitalize">${type
            .replace(/([A-Z])/g, " $1")
            .trim()}</label>`;
          const buttonGroup = document.createElement("div");
          buttonGroup.className = "grid grid-cols-2 md:grid-cols-4 gap-2";
          data.options.forEach((opt) => {
            const button = document.createElement("button");
            button.className = "btn-preset p-2 rounded-lg text-sm";
            if (userSelections[type] === opt.data)
              button.classList.add("active");
            button.textContent = opt.name;
            button.dataset.type = type;
            button.dataset.value = opt.data;
            buttonGroup.appendChild(button);
          });
          container.appendChild(buttonGroup);
          return container;
        };

        // --- STUDENT ASSISTANT & TTS FUNCTIONS ---
        const handleSend = () => {
          const userMessage = chatInput.value.trim();
          if (uploadedFile) {
            addChatMessage(
              "user",
              `${userMessage || `Analyzing: ${uploadedFile.name}`}`,
              true,
              true
            );
            handleFileAndQuery(uploadedFile, userMessage);
          } else if (userMessage && !isAuraTyping) {
            addChatMessage("user", userMessage, true, true);
          }
          chatInput.value = "";
          // Reset textarea height after sending
          chatInput.style.height = "auto";
          chatInput.style.overflowY = "hidden";
          chatInput.classList.add("rounded-full");
          chatInput.classList.remove("rounded-2xl");
        };

        async function handleInChatTaskSelection(button) {
          const task = button.dataset.task;
          if (!task) return;
          activeTask = task;

          const parentBubble = button.closest(".aura-message");
          parentBubble
            .querySelectorAll(".btn-task")
            .forEach((btn) => (btn.disabled = true));

          addChatMessage(
            "Aura",
            `Great. Please select the file you want me to '${task.replace(
              /-/g,
              " "
            )}'.`,
            false
          );
          fileUpload.click();
        }

        async function handleFileAndQuery(file, query) {
          let typingMsg;
          let isMediaFile =
            file.type.startsWith("audio/") || file.type.startsWith("video/");

          if (isMediaFile) {
            typingMsg = `Transcribing ${file.name}... This may take a moment.`;
          } else {
            typingMsg =
              file.type === "application/pdf"
                ? `Reading PDF...`
                : `Analyzing ${file.name}...`;
          }

          showTypingIndicator(typingMsg);
          setChatControlsDisabled(true);
          fileInfo.innerHTML = "";

          try {
            const fileData = await getFileContent(file);
            if (fileData === null) throw new Error("Unsupported file type.");

            let finalSystemPrompt;
            let payload;

            if (isMediaFile) {
              finalSystemPrompt =
                "You are an expert transcriptionist. Transcribe the following audio content accurately. Do not add any commentary, just provide the transcript.";
              payload = {
                contents: [
                  {
                    parts: [
                      { text: "Please transcribe this audio file." },
                      { inlineData: { mimeType: file.type, data: fileData } },
                    ],
                  },
                ],
                systemInstruction: { parts: [{ text: finalSystemPrompt }] },
              };
            } else {
              finalSystemPrompt =
                activeTask === "summarize-syllabus"
                  ? syllabusPrompts[userSelections.readingLevel]
                  : systemPrompts[userSelections.readingLevel];
              const userPromptText = `DOCUMENT CONTENT:\n"""\n${fileData}\n"""\n\nUSER QUESTION:\n"""\n${
                query || "Summarize this document."
              }\n"""`;
              const cleanHistory = chatHistory.map((m) => ({
                role: m.role,
                parts: [
                  {
                    text: m.parts[0].text
                      .replace(/<[^>]*>/g, " ")
                      .replace(/\s+/g, " ")
                      .trim(),
                  },
                ],
              }));
              payload = {
                contents: [
                  ...cleanHistory,
                  { role: "user", parts: [{ text: userPromptText }] },
                ],
                systemInstruction: { parts: [{ text: finalSystemPrompt }] },
              };
            }

            const responseText = await callGeminiAPI(payload, isMediaFile);
            chatHistory.push({
              role: "model",
              parts: [{ text: responseText }],
            });

            const formattedHtml = formatAIResponse(responseText);
            addChatMessage("model", formattedHtml, true, false);

            const lastMessageBubble = chatContainer.querySelector(
              ".flex.flex-col:last-child .message-content"
            );
            if (activeTask === "summarize-syllabus" && lastMessageBubble) {
              addCalendarButtons(lastMessageBubble);
            }
          } catch (error) {
            console.error("File processing error:", error);
            addChatMessage(
              "Aura",
              "I'm sorry, I encountered an error processing that file.",
              false
            );
          } finally {
            hideTypingIndicator();
            resetChatInput();
            setChatControlsDisabled(false);
          }
        }

        function getFileContent(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              if (
                file.type.startsWith("audio/") ||
                file.type.startsWith("video/")
              ) {
                // Extract Base64 data
                resolve(e.target.result.split(",")[1]);
              } else if (file.type === "application/pdf") {
                window.pdfjsLib
                  .getDocument(e.target.result)
                  .promise.then((pdf) => {
                    let fullText = "";
                    const pagePromises = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                      pagePromises.push(
                        pdf.getPage(i).then((page) => page.getTextContent())
                      );
                    }
                    Promise.all(pagePromises).then((textContents) => {
                      textContents.forEach((textContent) => {
                        fullText +=
                          textContent.items.map((item) => item.str).join(" ") +
                          "\n\n";
                      });
                      resolve(fullText);
                    });
                  })
                  .catch(reject);
              } else if (file.type === "text/plain") {
                resolve(e.target.result);
              } else {
                resolve(null);
              }
            };
            reader.onerror = (e) => reject(e);

            if (
              file.type.startsWith("audio/") ||
              file.type.startsWith("video/")
            ) {
              reader.readAsDataURL(file); // Read as Base64 Data URL
            } else if (file.type === "application/pdf") {
              reader.readAsArrayBuffer(file);
            } else {
              reader.readAsText(file);
            }
          });
        }

        function formatAIResponse(markdownText) {
          if (!markdownText) return "No response generated.";
          const lines = markdownText.split("\n");
          let html = "";
          let inList = false;

          for (let line of lines) {
            line = line
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
              .replace(/\*(.*?)\*/g, "<em>$1</em>");

            if (line.startsWith("### ")) {
              if (inList) {
                html += "</ul>";
                inList = false;
              }
              html += `<h3>${line.substring(4)}</h3>`;
            } else if (line.startsWith("## ")) {
              if (inList) {
                html += "</ul>";
                inList = false;
              }
              html += `<h2>${line.substring(3)}</h2>`;
            } else if (line.startsWith("# ")) {
              if (inList) {
                html += "</ul>";
                inList = false;
              }
              html += `<h1>${line.substring(2)}</h1>`;
            } else if (line.startsWith("- ") || line.startsWith("* ")) {
              if (!inList) {
                html += "<ul>";
                inList = true;
              }
              html += `<li>${line.substring(2)}</li>`;
            } else if (line.trim() !== "") {
              if (inList) {
                html += "</ul>";
                inList = false;
              }
              html += `<p>${line}</p>`;
            }
          }

          if (inList) {
            html += "</ul>";
          }
          return html;
        }

        function resetTTSPlayer(player) {
          if (!player) return;
          player.dataset.state = "idle";
          player.innerHTML = `<button class="speaker-icon" aria-label="Read message aloud"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 5L6 9H2V15H6L11 19V5Z" stroke-width="2"/><path d="M15.54 8.46C16.48 9.4 17 10.65 17 12s-.52 2.6-1.46 3.54" stroke-width="2"/></svg></button>`;
        }

        async function generateAndPlayAudio(player) {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio.ontimeupdate = null;
          }
          if (activeTTSPlayer && activeTTSPlayer !== player) {
            resetTTSPlayer(activeTTSPlayer);
          }

          activeTTSPlayer = player;
          player.dataset.state = "loading";
          player.innerHTML = `<div class="w-6 h-6 border-2 border-text-secondary/50 border-t-text-secondary rounded-full animate-spin"></div>`;

          try {
            await new Promise((resolve) => requestAnimationFrame(resolve));
            const text = player.dataset.text;
            const audioUrl = await getAudioFromAPI(text);

            currentAudio = new Audio(audioUrl);

            currentAudio.addEventListener("loadedmetadata", () => {
              if (player.dataset.state === "loading") {
                renderFullPlayer(player, currentAudio, audioUrl);
                currentAudio.play();
              }
            });
            currentAudio.addEventListener("play", () => {
              player.dataset.state = "playing";
              updatePlayPauseIcon(player, true);
            });
            currentAudio.addEventListener("pause", () => {
              player.dataset.state = "paused";
              updatePlayPauseIcon(player, false);
            });
            currentAudio.addEventListener("ended", () => {
              if (player.dataset.state === "playing") {
                player.dataset.state = "paused";
                updatePlayPauseIcon(player, false);
                if (currentAudio) {
                  currentAudio.currentTime = 0;
                }
                updateProgress(player, currentAudio);
              }
            });
            currentAudio.addEventListener("timeupdate", () =>
              updateProgress(player, currentAudio)
            );
          } catch (error) {
            console.error("TTS Error:", error);
            resetTTSPlayer(player);
            addChatMessage(
              "Aura",
              "Sorry, I was unable to generate the audio for that message.",
              false
            );
          }
        }

        function renderFullPlayer(player, audioInstance, audioUrl) {
          const duration = audioInstance ? audioInstance.duration : 0;

          player.innerHTML = `
                <div class="flex items-center justify-end gap-2 w-full">
                     <button class="tts-rewind p-1"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19l-9-7 9-7v14z"/><path d="M22 19l-9-7 9-7v14z"/></svg></button>
                     <button class="tts-play-pause p-1"></button>
                     <span class="tts-time-current text-xs font-mono w-10 text-center">0:00</span>
                     <input type="range" class="tts-progress-bar w-full" value="0" max="100">
                     <span class="tts-time-duration text-xs font-mono w-10 text-center">${formatTime(
                       duration
                     )}</span>
                     <button class="tts-forward p-1"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 5l9 7-9 7V5z"/><path d="M2 5l9 7-9 7V5z"/></svg></button>
                     <button class="tts-stop p-1"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg></button>
                     <a class="download-audio-btn p-1" aria-label="Download audio" href="${audioUrl}" download="Aura_Response_${Date.now()}.wav">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                     </a>
                </div>
            `;
          updatePlayPauseIcon(player, false); // Start with play icon

          player
            .querySelector(".tts-play-pause")
            .addEventListener("click", () =>
              audioInstance.paused
                ? audioInstance.play()
                : audioInstance.pause()
            );
          player
            .querySelector(".tts-rewind")
            .addEventListener(
              "click",
              () =>
                (audioInstance.currentTime = Math.max(
                  0,
                  audioInstance.currentTime - 5
                ))
            );
          player
            .querySelector(".tts-forward")
            .addEventListener(
              "click",
              () =>
                (audioInstance.currentTime = Math.min(
                  audioInstance.duration,
                  audioInstance.currentTime + 5
                ))
            );
          player.querySelector(".tts-stop").addEventListener("click", () => {
            if (audioInstance) {
              audioInstance.pause();
              audioInstance.currentTime = 0;
            }
          });
          player
            .querySelector(".tts-progress-bar")
            .addEventListener("input", (e) => {
              audioInstance.currentTime =
                (e.target.value / 100) * audioInstance.duration;
            });
        }

        function updatePlayPauseIcon(player, isPlaying) {
          const btn = player.querySelector(".tts-play-pause");
          if (btn) {
            btn.innerHTML = isPlaying
              ? `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>` // Pause Icon
              : `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>`; // Play Icon
          }
        }

        function updateProgress(player, audioInstance) {
          if (!audioInstance || !player || !audioInstance.duration) return;
          const progress = player.querySelector(".tts-progress-bar");
          const currentTimeEl = player.querySelector(".tts-time-current");
          if (progress && currentTimeEl) {
            progress.value =
              (audioInstance.currentTime / audioInstance.duration) * 100;
            currentTimeEl.textContent = formatTime(audioInstance.currentTime);
          }
        }

        function formatTime(seconds) {
          const min = Math.floor(seconds / 60);
          const sec = Math.floor(seconds % 60)
            .toString()
            .padStart(2, "0");
          return `${min}:${sec}`;
        }

        async function getAudioFromAPI(text) {
          for (let i = 0; i < 3; i++) {
            try {
              const model = "gemini-2.5-flash-preview-tts";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
              const payload = {
                contents: [
                  { parts: [{ text: `Say this naturally: ${text}` }] },
                ],
                generationConfig: { responseModalities: ["AUDIO"] },
                model: "gemini-2.5-flash-preview-tts",
              };
              const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!response.ok)
                throw new Error(`TTS API Error: ${response.status}`);
              const result = await response.json();
              const part = result?.candidates?.[0]?.content?.parts?.[0];
              const audioData = part?.inlineData?.data;
              const mimeType = part?.inlineData?.mimeType;
              if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRate = parseInt(
                  mimeType.match(/rate=(\d+)/)[1],
                  10
                );
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                return URL.createObjectURL(wavBlob);
              } else {
                throw new Error("No audio data in response.");
              }
            } catch (error) {
              console.error(`TTS API attempt ${i + 1} failed`, error);
              if (i === 2) throw error;
              await new Promise((res) =>
                setTimeout(res, 4000 * 2 ** i + Math.random() * 1000)
              );
            }
          }
        }
        function pcmToWav(pcmData, sampleRate) {
          const numChannels = 1,
            bytesPerSample = 2,
            blockAlign = numChannels * bytesPerSample;
          const byteRate = sampleRate * blockAlign,
            dataSize = pcmData.length * bytesPerSample;
          const buffer = new ArrayBuffer(44 + dataSize);
          const view = new DataView(buffer);
          const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++)
              view.setUint8(offset + i, string.charCodeAt(i));
          };
          writeString(view, 0, "RIFF");
          view.setUint32(4, 36 + dataSize, true);
          writeString(view, 8, "WAVE");
          writeString(view, 12, "fmt ");
          view.setUint32(16, 16, true);
          view.setUint16(20, 1, true);
          view.setUint16(22, numChannels, true);
          view.setUint32(24, sampleRate, true);
          view.setUint32(28, byteRate, true);
          view.setUint16(32, blockAlign, true);
          view.setUint16(34, 16, true);
          writeString(view, 36, "data");
          view.setUint32(40, dataSize, true);
          let offset = 44;
          for (let i = 0; i < pcmData.length; i++, offset += 2) {
            view.setInt16(offset, pcmData[i], true);
          }
          return new Blob([view], { type: "audio/wav" });
        }
        function base64ToArrayBuffer(base64) {
          const binaryString = window.atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        }

        function resetChatInput() {
          uploadedFile = null;
          activeTask = null;
          fileInfo.innerHTML = "";
          fileUpload.value = "";
        }
        function setChatControlsDisabled(disabled) {
          chatInput.disabled = disabled;
          sendBtn.disabled = disabled;
          fileUpload.disabled = disabled;
        }

        function showNotification(message) {
          if (notificationTimeout) clearTimeout(notificationTimeout);
          notification.textContent = message;
          notification.classList.remove("opacity-0", "-translate-y-10");
          notificationTimeout = setTimeout(() => {
            notification.classList.add("opacity-0", "-translate-y-10");
          }, 3000);
        }

        function addCalendarButtons(messageBubble) {
          if (!messageBubble) return;
          const timeElements = messageBubble.querySelectorAll("time");
          timeElements.forEach((timeEl) => {
            const date = timeEl.getAttribute("datetime");
            const parentLi = timeEl.closest("li");
            if (!parentLi || !date) return;

            const title = parentLi.textContent.split(":")[0].trim();
            const button = document.createElement("button");
            button.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"/><path d="M16 17h-4v-4h4v4z"/></svg> <span>Add to Calendar</span>`;
            button.className =
              "add-to-calendar-btn ml-2 px-3 py-1 text-sm font-semibold rounded-full bg-[var(--accent)] text-white hover:bg-[var(--accent-hover)] transition-all inline-flex items-center gap-2 transform hover:scale-105";
            button.ariaLabel = `Add ${title} to calendar`;
            button.dataset.eventTitle = title;
            button.dataset.eventDate = date;

            parentLi.appendChild(button);
          });
        }

        function renderMarkdownToLines(doc, speaker, markdownText, maxWidth) {
          const lines = [];
          let currentHeight = 0;
          const lineHeight = 4.5;
          const paraSpacing = 3;

          doc.setFontSize(10);
          doc.setFont(undefined, "bold");
          lines.push({
            text: speaker,
            style: "bold",
            size: 10,
            x: 0,
            y: currentHeight,
          });
          currentHeight += lineHeight + paraSpacing;

          const textLines = markdownText.split("\n");
          let isFirstContentLine = true;

          textLines.forEach((mdLine) => {
            if (mdLine.trim() === "") return;

            let style = "normal";
            let size = 10;
            let indent = 0;
            let content = mdLine;
            let topMargin = isFirstContentLine ? 0 : paraSpacing;

            isFirstContentLine = false;

            if (mdLine.startsWith("### ")) {
              style = "bold";
              size = 11;
              content = mdLine.substring(4);
              topMargin = paraSpacing * 2;
            } else if (mdLine.startsWith("- ") || mdLine.startsWith("* ")) {
              content = mdLine.substring(2);
              indent = 5;
              topMargin = 1.5;
            }

            currentHeight += topMargin;

            doc.setFontSize(size);
            doc.setFont(undefined, style);
            const wrapped = doc.splitTextToSize(content, maxWidth - indent);

            wrapped.forEach((line, i) => {
              if (indent > 0 && i === 0) {
                lines.push({
                  text: "•",
                  style: "normal",
                  size: 10,
                  x: 0,
                  y: currentHeight,
                });
              }
              lines.push({
                text: line,
                style: style,
                size: size,
                x: indent,
                y: currentHeight,
              });
              currentHeight += lineHeight;
            });
          });

          return { lines, height: currentHeight };
        }

        function drawFormattedLines(doc, formattedLines, x, y) {
          formattedLines.forEach((line) => {
            doc.setFontSize(line.size);
            doc.setFont(undefined, line.style);
            doc.text(line.text, x + line.x, y + line.y);
          });
        }

        async function createCalendarEvent(title, date, buttonEl) {
          try {
            if (buttonEl) buttonEl.disabled = true;

            const authResponse = await arcadeClient.tools.authorize({
              tool_name: "GoogleCalendar.CreateEvent",
              user_id: "aura-user-id", // A unique ID for the user
            });

            if (authResponse.status !== "completed") {
              window.open(authResponse.url, "_blank");
              await arcadeClient.auth.waitForCompletion(authResponse);
            }

            await arcadeClient.tools.execute({
              tool_name: "GoogleCalendar.CreateEvent",
              input: {
                summary: title,
                start_datetime: `${date}T09:00:00`, // Default to 9am
                end_datetime: `${date}T10:00:00`,
                calendar_id: "primary",
              },
              user_id: "aura-user-id",
            });

            showNotification(`"${title}" added to your calendar!`);
            if (buttonEl) buttonEl.innerHTML = "✓";
          } catch (error) {
            console.error("Failed to create calendar event:", error);
            showNotification("Failed to add event.");
            if (buttonEl) buttonEl.disabled = false;
          }
        }

        async function init() {
          try {
            // Fetch keys from our own server's endpoint
            const response = await fetch("/api/keys");
            if (!response.ok) {
              throw new Error("Failed to fetch API keys");
            }
            const keys = await response.json();
            GEMINI_API_KEY = keys.geminiApiKey;
            ARCADE_API_KEY = keys.arcadeApiKey;

            console.log("API Keys loaded successfully.");

            // Initialize the Arcade client now that we have the key
            if (window.Arcade) {
              arcadeClient = new window.Arcade.default({
                apiKey: ARCADE_API_KEY,
              });
            }
          } catch (error) {
            console.error(error);
            // Display an error to the user if keys can't be loaded
            document.body.innerHTML = `<div style="color: red; padding: 20px; font-family: sans-serif;">Error: Could not load application configuration. Please check the server.</div>`;
            return;
          }

          applySettings();
          Object.keys(onboardingData).forEach((_, i) =>
            mainOnboardingArea.appendChild(createStepElement(i + 1))
          );
          showStep(1);

          // Global Event Listeners
          document.addEventListener("mousemove", (e) => {
            spotlight.style.setProperty("--x", `${e.clientX}px`);
            spotlight.style.setProperty("--y", `${e.clientY}px`);
            spotlight.style.setProperty("--x2", `${e.clientX * 0.7}px`);
            spotlight.style.setProperty("--y2", `${e.clientY * 1.3}px`);
          });
          document.addEventListener("keydown", (e) => {
            if (e.key === "/") {
              if (document.activeElement !== chatInput) e.preventDefault();
              chatInput.focus();
            }
            if ((e.metaKey || e.ctrlKey) && e.key === "u") {
              e.preventDefault();
              fileUpload.click();
            }
            if (
              e.key === "Escape" &&
              !settingsModal.classList.contains("hidden")
            ) {
              closeSettingsModal();
            }
          });

          // Onboarding Listeners
          nextBtn.addEventListener("click", () => {
            if (currentStep < 4) showStep(++currentStep);
            else if (Object.values(userSelections).every((val) => val !== null))
              startDashboard();
          });
          backBtn.addEventListener("click", () =>
            currentStep > 1 ? showStep(--currentStep) : null
          );

          // Dashboard Listeners
          sendBtn.addEventListener("click", handleSend);

          chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              handleSend();
            }
          });

          // Auto-resize for textarea
          chatInput.addEventListener("input", () => {
            const maxHeight = 120; // Approx 5 rows height
            chatInput.style.height = "auto"; // Reset height
            const scrollHeight = chatInput.scrollHeight;

            if (scrollHeight > maxHeight) {
              chatInput.style.height = `${maxHeight}px`;
              chatInput.style.overflowY = "auto";
            } else {
              chatInput.style.height = `${scrollHeight}px`;
              chatInput.style.overflowY = "hidden";
            }

            // Adjust padding for multi-line
            if (chatInput.scrollHeight > 50) {
              // arbitrary value for more than one line
              chatInput.classList.remove("rounded-full");
              chatInput.classList.add("rounded-2xl");
            } else {
              chatInput.classList.add("rounded-full");
              chatInput.classList.remove("rounded-2xl");
            }
          });

          fileUpload.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) {
              resetChatInput();
              return;
            }

            uploadedFile = file;
            fileInfo.innerHTML = `
                    <div class="glass-card p-2 px-3 rounded-lg flex items-center gap-2 animate-enter">
                        <svg class="w-5 h-5 text-text-secondary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                        <span class="truncate max-w-[200px] inline-block text-sm">${file.name}</span>
                        <button id="remove-file-btn" class="ml-auto text-red-500 hover:text-red-700 flex-shrink-0">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
            if (activeTask)
              handleFileAndQuery(
                uploadedFile,
                `Perform the task: ${activeTask.replace(/-/g, " ")}`
              );
          });

          fileInfo.addEventListener("click", (e) => {
            if (e.target.closest("#remove-file-btn")) resetChatInput();
          });

          settingsBtn.addEventListener("click", openSettingsModal);

          downloadBtn.addEventListener("click", () => {
            try {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              const margin = 15;
              const bubblePadding = 8;
              const pageHeight = doc.internal.pageSize.height;
              const pageWidth = doc.internal.pageSize.width;
              const maxBubbleWidth = pageWidth * 0.75;
              let y = 20;

              // Title
              doc.setFontSize(18);
              doc.setFont(undefined, "bold");
              doc.text("Aura Chat Transcript", margin, y);
              y += 20;

              chatHistory.forEach((message) => {
                const isUser = message.role === "user";
                const rawText = message.parts[0].text;
                const speaker = isUser ? "You:" : "Aura:";
                const bubbleX = isUser
                  ? pageWidth - maxBubbleWidth - margin
                  : margin;

                const { lines, height } = renderMarkdownToLines(
                  doc,
                  speaker,
                  rawText,
                  maxBubbleWidth - bubblePadding * 2
                );
                const bubbleHeight = height + bubblePadding * 2;

                if (y + bubbleHeight > pageHeight - margin) {
                  doc.addPage();
                  y = margin;
                }

                const userBubbleColor = "#007AFF";
                const auraBubbleColor = "#E5E5EA";
                const userTextColor = "#FFFFFF";
                const auraTextColor = "#1D1D1F";

                doc.setFillColor(isUser ? userBubbleColor : auraBubbleColor);
                doc.roundedRect(
                  bubbleX,
                  y,
                  maxBubbleWidth,
                  bubbleHeight,
                  3,
                  3,
                  "F"
                );
                doc.setTextColor(isUser ? userTextColor : auraTextColor);

                drawFormattedLines(
                  doc,
                  lines,
                  bubbleX + bubblePadding,
                  y + bubblePadding + 3
                );

                y += bubbleHeight + 10;
              });

              doc.save(
                `Aura-Transcript-${new Date().toISOString().slice(0, 10)}.pdf`
              );
            } catch (e) {
              console.error("PDF generation failed:", e);
              showNotification("Error: Could not generate PDF.");
            }
          });

          chatContainer.addEventListener("click", async (e) => {
            const player = e.target.closest(".tts-player");
            if (player) {
              if (player.dataset.state === "idle") generateAndPlayAudio(player);
              else if (player.dataset.state === "playing")
                currentAudio?.pause();
              else if (player.dataset.state === "paused") currentAudio?.play();
            }

            const taskButton = e.target.closest(".btn-task");
            if (taskButton) {
              handleInChatTaskSelection(taskButton);
            }

            const copyBtn = e.target.closest(".copy-btn");
            if (copyBtn) {
              const messageContent = copyBtn
                .closest(".flex.flex-col")
                .querySelector(".message-content").innerText;
              const textToCopy = "Aura: " + messageContent;
              const textArea = document.createElement("textarea");
              textArea.value = textToCopy;
              textArea.style.position = "fixed";
              textArea.style.left = "-9999px";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              try {
                document.execCommand("copy");
                showNotification("Copied to clipboard!");
                copyBtn.innerHTML = `<svg class="w-5 h-5 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                setTimeout(() => {
                  copyBtn.innerHTML = `<svg class="w-5 h-5 text-text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 2000);
              } catch (err) {
                showNotification("Failed to copy!");
              }
              document.body.removeChild(textArea);
            }

            const calendarBtn = e.target.closest(".add-to-calendar-btn");
            if (calendarBtn) {
              if (!arcadeClient) {
                showNotification(
                  "Calendar feature is not available. Please verify your Arcade Public Key."
                );
                console.error(
                  "Arcade SDK not initialized. Please verify the Public API Key."
                );
                return;
              }
              const { eventTitle, eventDate } = calendarBtn.dataset;
              createCalendarEvent(eventTitle, eventDate, calendarBtn);
            }
          });

          settingsModal.addEventListener("click", (e) => {
            if (e.target === settingsModal) closeSettingsModal();
          });
          settingsModalContent.addEventListener("click", (e) => {
            const button = e.target.closest(".btn-preset");
            if (!button) return;
            const { type, value } = button.dataset;
            userSelections[type] = value;
            applySettings();
            const group = button.parentElement;
            group
              .querySelectorAll(".btn-preset")
              .forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
          });
        }

        // Call the async init function to start the app
        init();
      });
    </script>
  </body>
</html>
